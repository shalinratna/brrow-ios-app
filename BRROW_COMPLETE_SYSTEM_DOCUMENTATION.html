<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brrow Complete System Documentation</title>
    <style>
    /* Brrow Professional PDF Styling */
/* Brand Colors: Blue (#007AFF), White (#FFFFFF), Green (#34C759) */

@page {
    size: A4;
    margin: 2.5cm 2cm 2.5cm 2cm;

    @top-center {
        content: "Brrow Complete System Documentation";
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        font-size: 10pt;
        color: #666;
        border-bottom: 1px solid #007AFF;
        padding-bottom: 5px;
    }

    @bottom-right {
        content: "Page " counter(page);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        font-size: 10pt;
        color: #666;
    }
}

@page :first {
    @top-center {
        content: "";
    }
    @bottom-right {
        content: "";
    }
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    font-size: 11pt;
    line-height: 1.6;
    color: #1d1d1f;
    background: white;
}

/* Headings */
h1 {
    color: #007AFF;
    font-size: 32pt;
    font-weight: 700;
    margin: 40pt 0 20pt 0;
    padding-bottom: 10pt;
    border-bottom: 3px solid #34C759;
    page-break-after: avoid;
    page-break-inside: avoid;
}

h2 {
    color: #007AFF;
    font-size: 24pt;
    font-weight: 600;
    margin: 30pt 0 15pt 0;
    padding-bottom: 8pt;
    border-bottom: 2px solid #34C759;
    page-break-after: avoid;
    page-break-inside: avoid;
}

h3 {
    color: #007AFF;
    font-size: 18pt;
    font-weight: 600;
    margin: 25pt 0 12pt 0;
    page-break-after: avoid;
    page-break-inside: avoid;
}

h4 {
    color: #007AFF;
    font-size: 14pt;
    font-weight: 600;
    margin: 20pt 0 10pt 0;
    page-break-after: avoid;
    page-break-inside: avoid;
}

h5 {
    color: #007AFF;
    font-size: 12pt;
    font-weight: 600;
    margin: 15pt 0 8pt 0;
    page-break-after: avoid;
    page-break-inside: avoid;
}

h6 {
    color: #007AFF;
    font-size: 11pt;
    font-weight: 600;
    margin: 15pt 0 8pt 0;
    page-break-after: avoid;
    page-break-inside: avoid;
}

/* Paragraphs */
p {
    margin: 0 0 12pt 0;
    text-align: justify;
}

/* Lists */
ul, ol {
    margin: 12pt 0 12pt 20pt;
    padding-left: 20pt;
}

li {
    margin: 6pt 0;
    line-height: 1.5;
}

/* Code Blocks */
pre {
    background: #f5f5f7;
    border-left: 4px solid #007AFF;
    padding: 15pt;
    margin: 15pt 0;
    overflow-x: auto;
    page-break-inside: avoid;
    border-radius: 4pt;
}

code {
    font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Menlo, Consolas, monospace;
    font-size: 9pt;
    background: #f5f5f7;
    padding: 2pt 4pt;
    border-radius: 3pt;
    color: #007AFF;
}

pre code {
    background: transparent;
    padding: 0;
    color: #1d1d1f;
    font-size: 9pt;
    line-height: 1.4;
}

/* Syntax Highlighting */
.codehilite .hll { background-color: #ffffcc }
.codehilite .c { color: #8e908c } /* Comment */
.codehilite .err { color: #960050 } /* Error */
.codehilite .k { color: #007AFF; font-weight: bold } /* Keyword */
.codehilite .l { color: #ae81ff } /* Literal */
.codehilite .n { color: #1d1d1f } /* Name */
.codehilite .o { color: #34C759 } /* Operator */
.codehilite .p { color: #1d1d1f } /* Punctuation */
.codehilite .cm { color: #8e908c } /* Comment.Multiline */
.codehilite .cp { color: #8e908c } /* Comment.Preproc */
.codehilite .c1 { color: #8e908c } /* Comment.Single */
.codehilite .cs { color: #8e908c } /* Comment.Special */
.codehilite .gd { color: #f92672 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gi { color: #34C759 } /* Generic.Inserted */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .kc { color: #007AFF } /* Keyword.Constant */
.codehilite .kd { color: #007AFF } /* Keyword.Declaration */
.codehilite .kn { color: #34C759 } /* Keyword.Namespace */
.codehilite .kp { color: #007AFF } /* Keyword.Pseudo */
.codehilite .kr { color: #007AFF } /* Keyword.Reserved */
.codehilite .kt { color: #007AFF } /* Keyword.Type */
.codehilite .ld { color: #e6db74 } /* Literal.Date */
.codehilite .m { color: #ae81ff } /* Literal.Number */
.codehilite .s { color: #e6db74 } /* Literal.String */
.codehilite .na { color: #34C759 } /* Name.Attribute */
.codehilite .nb { color: #1d1d1f } /* Name.Builtin */
.codehilite .nc { color: #34C759 } /* Name.Class */
.codehilite .no { color: #007AFF } /* Name.Constant */
.codehilite .nd { color: #34C759 } /* Name.Decorator */
.codehilite .ni { color: #1d1d1f } /* Name.Entity */
.codehilite .ne { color: #34C759 } /* Name.Exception */
.codehilite .nf { color: #34C759 } /* Name.Function */
.codehilite .nl { color: #1d1d1f } /* Name.Label */
.codehilite .nn { color: #1d1d1f } /* Name.Namespace */
.codehilite .nx { color: #34C759 } /* Name.Other */
.codehilite .py { color: #1d1d1f } /* Name.Property */
.codehilite .nt { color: #007AFF } /* Name.Tag */
.codehilite .nv { color: #1d1d1f } /* Name.Variable */
.codehilite .ow { color: #34C759 } /* Operator.Word */
.codehilite .w { color: #1d1d1f } /* Text.Whitespace */
.codehilite .mf { color: #ae81ff } /* Literal.Number.Float */
.codehilite .mh { color: #ae81ff } /* Literal.Number.Hex */
.codehilite .mi { color: #ae81ff } /* Literal.Number.Integer */
.codehilite .mo { color: #ae81ff } /* Literal.Number.Oct */
.codehilite .sb { color: #e6db74 } /* Literal.String.Backtick */
.codehilite .sc { color: #e6db74 } /* Literal.String.Char */
.codehilite .sd { color: #e6db74 } /* Literal.String.Doc */
.codehilite .s2 { color: #e6db74 } /* Literal.String.Double */
.codehilite .se { color: #ae81ff } /* Literal.String.Escape */
.codehilite .sh { color: #e6db74 } /* Literal.String.Heredoc */
.codehilite .si { color: #e6db74 } /* Literal.String.Interpol */
.codehilite .sx { color: #e6db74 } /* Literal.String.Other */
.codehilite .sr { color: #e6db74 } /* Literal.String.Regex */
.codehilite .s1 { color: #e6db74 } /* Literal.String.Single */
.codehilite .ss { color: #e6db74 } /* Literal.String.Symbol */
.codehilite .bp { color: #1d1d1f } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #1d1d1f } /* Name.Variable.Class */
.codehilite .vg { color: #1d1d1f } /* Name.Variable.Global */
.codehilite .vi { color: #1d1d1f } /* Name.Variable.Instance */
.codehilite .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 20pt 0;
    page-break-inside: avoid;
}

thead {
    background: #007AFF;
    color: white;
}

th {
    padding: 12pt;
    text-align: left;
    font-weight: 600;
    border: 1px solid #007AFF;
}

td {
    padding: 10pt;
    border: 1px solid #d2d2d7;
}

tr:nth-child(even) {
    background: #f5f5f7;
}

/* Blockquotes */
blockquote {
    border-left: 4px solid #34C759;
    padding: 12pt 20pt;
    margin: 15pt 0;
    background: #f5f5f7;
    font-style: italic;
    color: #1d1d1f;
    page-break-inside: avoid;
}

/* Links */
a {
    color: #007AFF;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

/* Horizontal Rules */
hr {
    border: none;
    border-top: 2px solid #34C759;
    margin: 30pt 0;
}

/* Images */
img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20pt auto;
    page-break-inside: avoid;
}

/* Table of Contents */
.toc {
    background: #f5f5f7;
    border: 2px solid #007AFF;
    padding: 20pt;
    margin: 30pt 0;
    border-radius: 8pt;
    page-break-after: always;
}

.toc h1, .toc h2 {
    color: #007AFF;
    border: none;
    margin: 0 0 15pt 0;
    padding: 0;
}

.toc ul {
    list-style: none;
    padding-left: 0;
}

.toc li {
    margin: 8pt 0;
}

.toc a {
    color: #007AFF;
    text-decoration: none;
}

.toc a:hover {
    text-decoration: underline;
}

/* Cover Page */
.cover-page {
    text-align: center;
    page-break-after: always;
    padding-top: 150pt;
}

.cover-page h1 {
    font-size: 48pt;
    color: #007AFF;
    margin-bottom: 20pt;
    border: none;
}

.cover-page .subtitle {
    font-size: 24pt;
    color: #34C759;
    margin-bottom: 40pt;
}

.cover-page .date {
    font-size: 14pt;
    color: #666;
}

/* Chapter Breaks */
.chapter {
    page-break-before: always;
}

/* Strong and Emphasis */
strong, b {
    font-weight: 700;
    color: #007AFF;
}

em, i {
    font-style: italic;
    color: #1d1d1f;
}

/* Definition Lists */
dl {
    margin: 15pt 0;
}

dt {
    font-weight: 700;
    color: #007AFF;
    margin-top: 10pt;
}

dd {
    margin-left: 20pt;
    margin-bottom: 10pt;
}

/* Print optimizations */
@media print {
    body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

    </style>
</head>
<body>
    
    <div class="cover-page">
        <h1>Brrow</h1>
        <div class="subtitle">Complete System Documentation</div>
        <div class="date">Generated on October 08, 2025</div>
    </div>
    
    
    <div class="toc">
        <h1>Table of Contents</h1>
        <ul>
    
            <li><a href="#-brrow-complete-system-documentation">ğŸ“˜ Brrow - Complete System Documentation</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#-document-theme">ğŸ¨ Document Theme</a></li>
        
            <li><a href="#-table-of-contents">ğŸ“‘ Table of Contents</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-1-system-overview">Part 1: System Overview</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-2-backend-systems">Part 2: Backend Systems</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-3-ios-application">Part 3: iOS Application</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-4-third-party-integrations">Part 4: Third-Party Integrations</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-5-core-features">Part 5: Core Features</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-6-payment-systems">Part 6: Payment Systems</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-7-deployment-infrastructure">Part 7: Deployment & Infrastructure</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-8-development-guides">Part 8: Development Guides</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-9-xcode-ios-build">Part 9: Xcode & iOS Build</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#part-10-maintenance-updates">Part 10: Maintenance & Updates</a></li>
        
            <li><a href="#part-1-system-overview">Part 1: System Overview</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#executive-summary">Executive Summary</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#architecture-overview">Architecture Overview</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#technology-stack">Technology Stack</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#key-features">Key Features</a></li>
        
            <li><a href="#part-2-backend-systems">Part 2: Backend Systems</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#backend-architecture">Backend Architecture</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#database-schema">Database Schema</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#api-endpoints">API Endpoints</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#authentication-security">Authentication & Security</a></li>
        
            <li><a href="#part-3-ios-application">Part 3: iOS Application</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ios-architecture">iOS Architecture</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#navigation-system">Navigation System</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#state-management">State Management</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ui-components">UI Components</a></li>
        
            <li><a href="#part-4-third-party-integrations">Part 4: Third-Party Integrations</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#stripe-payment-system">Stripe Payment System</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#stripe-connect-seller-payments">Stripe Connect (Seller Payments)</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#firebase-services">Firebase Services</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#cloudinary-image-storage">Cloudinary (Image Storage)</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#idme-verification">ID.me Verification</a></li>
        
            <li><a href="#part-5-core-features">Part 5: Core Features</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#marketplace-system">Marketplace System</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#messaging-system">Messaging System</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#listing-management">Listing Management</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#user-profiles">User Profiles</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#search-discovery">Search & Discovery</a></li>
        
            <li><a href="#part-6-payment-systems">Part 6: Payment Systems</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#buy-now-direct-purchase">Buy Now (Direct Purchase)</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#seller-payouts">Seller Payouts</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#transaction-history">Transaction History</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#refunds-disputes">Refunds & Disputes</a></li>
        
            <li><a href="#part-7-deployment-infrastructure">Part 7: Deployment & Infrastructure</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#railway-deployment">Railway Deployment</a></li>
        
            <li><a href="#railway-runs-these-automatically">Railway runs these automatically:</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#environment-variables">Environment Variables</a></li>
        
            <li><a href="#database">Database</a></li>
        
            <li><a href="#jwt">JWT</a></li>
        
            <li><a href="#stripe">Stripe</a></li>
        
            <li><a href="#cloudinary">Cloudinary</a></li>
        
            <li><a href="#firebase">Firebase</a></li>
        
            <li><a href="#idme">ID.me</a></li>
        
            <li><a href="#google-oauth">Google OAuth</a></li>
        
            <li><a href="#discord-for-error-logging">Discord (for error logging)</a></li>
        
            <li><a href="#server-config">Server Config</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#database-management">Database Management</a></li>
        
            <li><a href="#install-railway-cli">Install Railway CLI</a></li>
        
            <li><a href="#login">Login</a></li>
        
            <li><a href="#link-project">Link project</a></li>
        
            <li><a href="#connect-to-postgresql">Connect to PostgreSQL</a></li>
        
            <li><a href="#create-migration">Create migration</a></li>
        
            <li><a href="#push-to-database-skip-migration">Push to database (skip migration)</a></li>
        
            <li><a href="#generate-prisma-client">Generate Prisma Client</a></li>
        
            <li><a href="#on-deploy-railway-runs">On deploy, Railway runs:</a></li>
        
            <li><a href="#manual-migration">Manual migration:</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#monitoring-logging">Monitoring & Logging</a></li>
        
            <li><a href="#part-8-development-guides">Part 8: Development Guides</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#local-development-setup">Local Development Setup</a></li>
        
            <li><a href="#edit-env-with-your-credentials">Edit .env with your credentials</a></li>
        
            <li><a href="#start-postgresql-if-local">Start PostgreSQL (if local)</a></li>
        
            <li><a href="#create-database">Create database</a></li>
        
            <li><a href="#update-database_url-in-env">Update DATABASE_URL in .env</a></li>
        
            <li><a href="#run-migrations">Run migrations</a></li>
        
            <li><a href="#generate-prisma-client">Generate Prisma Client</a></li>
        
            <li><a href="#server-runs-on-httplocalhost3001">Server runs on http://localhost:3001</a></li>
        
            <li><a href="#should-return-statushealthy">Should return: {"status":"healthy",...}</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#testing-strategies">Testing Strategies</a></li>
        
            <li><a href="#create-test-user-via-api">Create test user via API</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#debugging-tools">Debugging Tools</a></li>
        
            <li><a href="#log-all-prisma-queries-add-to-env">Log all Prisma queries (add to .env)</a></li>
        
            <li><a href="#restart-server-see-all-sql-queries-in-console">Restart server, see all SQL queries in console</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#common-issues-fixes">Common Issues & Fixes</a></li>
        
            <li><a href="#check-railway-logs-for">Check Railway logs for:</a></li>
        
            <li><a href="#should-show-cfbundleidentifier-cfbundleversion-etc">Should show CFBundleIdentifier, CFBundleVersion, etc.</a></li>
        
            <li><a href="#clear-xcode-cache">Clear Xcode cache</a></li>
        
            <li><a href="#check-railway-logs-for">Check Railway logs for:</a></li>
        
            <li><a href="#part-9-xcode-ios-build">Part 9: Xcode & iOS Build</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xcode-project-structure">Xcode Project Structure</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#archive-distribution">Archive & Distribution</a></li>
        
            <li><a href="#add-applicationproperties-if-missing">Add ApplicationProperties if missing</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#cocoapods-dependencies">CocoaPods Dependencies</a></li>
        
            <li><a href="#edit-podfile">Edit Podfile</a></li>
        
            <li><a href="#install">Install</a></li>
        
            <li><a href="#remove-from-podfile">Remove from Podfile</a></li>
        
            <li><a href="#then">Then:</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#app-store-submission">App Store Submission</a></li>
        
            <li><a href="#part-10-maintenance-updates">Part 10: Maintenance & Updates</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#version-management">Version Management</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#update-procedures">Update Procedures</a></li>
        
            <li><a href="#edit-files">Edit files</a></li>
        
            <li><a href="#test-on-httplocalhost3001">Test on http://localhost:3001</a></li>
        
            <li><a href="#check-version-number">Check version number</a></li>
        
            <li><a href="#edit-swift-files-in-xcode">Edit Swift files in Xcode</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rollback-strategies">Rollback Strategies</a></li>
        
            <li><a href="#find-bad-commit">Find bad commit</a></li>
        
            <li><a href="#revert-it">Revert it</a></li>
        
            <li><a href="#railway-auto-deploys-reverted-code">Railway auto-deploys reverted code</a></li>
        
            <li><a href="#reset-to-previous-commit">Reset to previous commit</a></li>
        
            <li><a href="#-use-with-caution-rewrites-history">âš ï¸ Use with caution - rewrites history</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#security-updates">Security Updates</a></li>
        
            <li><a href="#check-for-updates">Check for updates</a></li>
        
            <li><a href="#update-specific-package">Update specific package</a></li>
        
            <li><a href="#update-all-careful">Update all (careful!)</a></li>
        
            <li><a href="#audit-for-vulnerabilities">Audit for vulnerabilities</a></li>
        
            <li><a href="#check-for-updates">Check for updates</a></li>
        
            <li><a href="#update-specific-pod">Update specific pod</a></li>
        
            <li><a href="#update-all">Update all</a></li>
        
            <li><a href="#-quick-reference">ğŸ“Œ Quick Reference</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#essential-urls">Essential URLs</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#essential-commands">Essential Commands</a></li>
        
            <li><a href="#start-locally">Start locally</a></li>
        
            <li><a href="#database-migrations">Database migrations</a></li>
        
            <li><a href="#deploy-auto-via-git-push">Deploy (auto via git push)</a></li>
        
            <li><a href="#install-dependencies">Install dependencies</a></li>
        
            <li><a href="#clean-build">Clean build</a></li>
        
            <li><a href="#archive">Archive</a></li>
        
            <li><a href="#run">Run</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#essential-environment-variables">Essential Environment Variables</a></li>
        
            <li>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#support-contacts">Support Contacts</a></li>
        
            <li><a href="#-document-update-log">ğŸ“ Document Update Log</a></li>
        
        </ul>
    </div>
    
    <div class="content">
        <h1 id="brrow-complete-system-documentation">ğŸ“˜ Brrow - Complete System Documentation</h1>

<blockquote>
  <p><strong>Version 1.3.4</strong> | Last Updated: October 8, 2025
  <strong>Author</strong>: Claude Code (Anthropic)
  <strong>Owner</strong>: Shalin Ratna</p>
</blockquote>

<hr />

<h2 id="document-theme">ğŸ¨ Document Theme</h2>

<p><strong>Colors</strong>: Blue (#007AFF), White (#FFFFFF), Green (#34C759)
<strong>Style</strong>: Professional, Clean, Easy to Navigate</p>

<hr />

<h1 id="table-of-contents">ğŸ“‘ Table of Contents</h1>

<h2 id="part-1-system-overview">Part 1: System Overview</h2>

<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#technology-stack">Technology Stack</a></li>
<li><a href="#key-features">Key Features</a></li>
</ol>

<h2 id="part-2-backend-systems">Part 2: Backend Systems</h2>

<ol start="5">
<li><a href="#backend-architecture">Backend Architecture</a></li>
<li><a href="#database-schema">Database Schema</a></li>
<li><a href="#api-endpoints">API Endpoints</a></li>
<li><a href="#authentication--security">Authentication &amp; Security</a></li>
</ol>

<h2 id="part-3-ios-application">Part 3: iOS Application</h2>

<ol start="9">
<li><a href="#ios-architecture">iOS Architecture</a></li>
<li><a href="#navigation-system">Navigation System</a></li>
<li><a href="#state-management">State Management</a></li>
<li><a href="#ui-components">UI Components</a></li>
</ol>

<h2 id="part-4-third-party-integrations">Part 4: Third-Party Integrations</h2>

<ol start="13">
<li><a href="#stripe-payment-system">Stripe Payment System</a></li>
<li><a href="#stripe-connect-seller-payments">Stripe Connect (Seller Payments)</a></li>
<li><a href="#firebase-services">Firebase Services</a></li>
<li><a href="#cloudinary-image-storage">Cloudinary (Image Storage)</a></li>
<li><a href="#idme-verification">ID.me Verification</a></li>
</ol>

<h2 id="part-5-core-features">Part 5: Core Features</h2>

<ol start="18">
<li><a href="#marketplace-system">Marketplace System</a></li>
<li><a href="#messaging-system">Messaging System</a></li>
<li><a href="#listing-management">Listing Management</a></li>
<li><a href="#user-profiles">User Profiles</a></li>
<li><a href="#search--discovery">Search &amp; Discovery</a></li>
</ol>

<h2 id="part-6-payment-systems">Part 6: Payment Systems</h2>

<ol start="23">
<li><a href="#buy-now-direct-purchase">Buy Now (Direct Purchase)</a></li>
<li><a href="#seller-payouts">Seller Payouts</a></li>
<li><a href="#transaction-history">Transaction History</a></li>
<li><a href="#refunds--disputes">Refunds &amp; Disputes</a></li>
</ol>

<h2 id="part-7-deployment-infrastructure">Part 7: Deployment &amp; Infrastructure</h2>

<ol start="27">
<li><a href="#railway-deployment">Railway Deployment</a></li>
<li><a href="#environment-variables">Environment Variables</a></li>
<li><a href="#database-management">Database Management</a></li>
<li><a href="#monitoring--logging">Monitoring &amp; Logging</a></li>
</ol>

<h2 id="part-8-development-guides">Part 8: Development Guides</h2>

<ol start="31">
<li><a href="#local-development-setup">Local Development Setup</a></li>
<li><a href="#testing-strategies">Testing Strategies</a></li>
<li><a href="#debugging-tools">Debugging Tools</a></li>
<li><a href="#common-issues--fixes">Common Issues &amp; Fixes</a></li>
</ol>

<h2 id="part-9-xcode-ios-build">Part 9: Xcode &amp; iOS Build</h2>

<ol start="35">
<li><a href="#xcode-project-structure">Xcode Project Structure</a></li>
<li><a href="#archive--distribution">Archive &amp; Distribution</a></li>
<li><a href="#cocoapods-dependencies">CocoaPods Dependencies</a></li>
<li><a href="#app-store-submission">App Store Submission</a></li>
</ol>

<h2 id="part-10-maintenance-updates">Part 10: Maintenance &amp; Updates</h2>

<ol start="39">
<li><a href="#version-management">Version Management</a></li>
<li><a href="#update-procedures">Update Procedures</a></li>
<li><a href="#rollback-strategies">Rollback Strategies</a></li>
<li><a href="#security-updates">Security Updates</a></li>
</ol>

<hr />

<h1 id="part-1-system-overview-2">Part 1: System Overview</h1>

<h2 id="executive-summary">Executive Summary</h2>

<p><strong>Brrow</strong> is a peer-to-peer marketplace iOS application that enables users to buy, sell, and rent items within their local community. The platform features real-time messaging, secure payments via Stripe, identity verification through ID.me, and a sophisticated seller payout system using Stripe Connect.</p>

<h3 id="platform-status">Platform Status</h3>

<ul>
<li><strong>iOS Version</strong>: 1.3.4 (Build 594)</li>
<li><strong>Backend Version</strong>: 1.3.4</li>
<li><strong>Production URL</strong>: https://brrow-backend-nodejs-production.up.railway.app</li>
<li><strong>Platform</strong>: iOS 16+</li>
<li><strong>Database</strong>: PostgreSQL (Railway)</li>
<li><strong>Users</strong>: 143 active</li>
<li><strong>Listings</strong>: 7 active</li>
<li><strong>Status</strong>: âœ… Fully Operational</li>
</ul>

<hr />

<h2 id="architecture-overview">Architecture Overview</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iOS Application                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SwiftUI Viewsâ”‚  â”‚ ViewModels   â”‚  â”‚ API Client   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS/JSON
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Node.js Backend (Railway)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Express.js   â”‚  â”‚ Prisma ORM   â”‚  â”‚ WebSockets   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚ â”‚   Stripe    â”‚ â”‚ Firebase    â”‚
â”‚  Database   â”‚ â”‚  Payments   â”‚ â”‚  Services   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<h3 id="data-flow">Data Flow</h3>

<ol>
<li><strong>User Action</strong> â†’ iOS App</li>
<li><strong>API Request</strong> â†’ Backend (via HTTPS)</li>
<li><strong>Authentication</strong> â†’ JWT Token Validation</li>
<li><strong>Database Query</strong> â†’ PostgreSQL via Prisma</li>
<li><strong>Response</strong> â†’ JSON back to iOS</li>
<li><strong>UI Update</strong> â†’ SwiftUI re-renders</li>
</ol>

<hr />

<h2 id="technology-stack">Technology Stack</h2>

<h3 id="ios-stack">iOS Stack</h3>

<table>
<thead>
<tr>
  <th>Component</th>
  <th>Technology</th>
  <th>Version</th>
  <th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Language</td>
  <td>Swift</td>
  <td>5.9+</td>
  <td>App Development</td>
</tr>
<tr>
  <td>UI Framework</td>
  <td>SwiftUI</td>
  <td>iOS 16+</td>
  <td>User Interface</td>
</tr>
<tr>
  <td>Networking</td>
  <td>URLSession</td>
  <td>Native</td>
  <td>API Communication</td>
</tr>
<tr>
  <td>Image Loading</td>
  <td>SDWebImage</td>
  <td>5.19.7</td>
  <td>Async Image Loading</td>
</tr>
<tr>
  <td>Real-time</td>
  <td>Socket.IO</td>
  <td>16.1.0</td>
  <td>Live Messaging</td>
</tr>
<tr>
  <td>Payments</td>
  <td>Stripe iOS SDK</td>
  <td>23.29.4</td>
  <td>Payment Processing</td>
</tr>
<tr>
  <td>Auth</td>
  <td>Firebase Auth</td>
  <td>10.29.0</td>
  <td>Authentication</td>
</tr>
<tr>
  <td>Push</td>
  <td>Firebase Messaging</td>
  <td>10.29.0</td>
  <td>Notifications</td>
</tr>
<tr>
  <td>Maps</td>
  <td>MapKit</td>
  <td>Native</td>
  <td>Location Services</td>
</tr>
</tbody>
</table>

<h3 id="backend-stack">Backend Stack</h3>

<table>
<thead>
<tr>
  <th>Component</th>
  <th>Technology</th>
  <th>Version</th>
  <th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Runtime</td>
  <td>Node.js</td>
  <td>18.20.8</td>
  <td>Server Runtime</td>
</tr>
<tr>
  <td>Framework</td>
  <td>Express.js</td>
  <td>4.x</td>
  <td>HTTP Server</td>
</tr>
<tr>
  <td>Database ORM</td>
  <td>Prisma</td>
  <td>6.16.2</td>
  <td>Database Access</td>
</tr>
<tr>
  <td>Database</td>
  <td>PostgreSQL</td>
  <td>15</td>
  <td>Data Storage</td>
</tr>
<tr>
  <td>Real-time</td>
  <td>Socket.IO</td>
  <td>Latest</td>
  <td>WebSocket Server</td>
</tr>
<tr>
  <td>Payments</td>
  <td>Stripe SDK</td>
  <td>Latest</td>
  <td>Payment Processing</td>
</tr>
<tr>
  <td>Images</td>
  <td>Cloudinary SDK</td>
  <td>Latest</td>
  <td>Image Storage</td>
</tr>
<tr>
  <td>Security</td>
  <td>Helmet.js</td>
  <td>Latest</td>
  <td>Security Headers</td>
</tr>
<tr>
  <td>Logging</td>
  <td>Pino</td>
  <td>Latest</td>
  <td>Structured Logging</td>
</tr>
</tbody>
</table>

<h3 id="infrastructure">Infrastructure</h3>

<table>
<thead>
<tr>
  <th>Component</th>
  <th>Provider</th>
  <th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Backend Hosting</td>
  <td>Railway</td>
  <td>Node.js Server</td>
</tr>
<tr>
  <td>Database</td>
  <td>Railway (PostgreSQL)</td>
  <td>Data Persistence</td>
</tr>
<tr>
  <td>Image Storage</td>
  <td>Cloudinary</td>
  <td>User Images</td>
</tr>
<tr>
  <td>Payment Processing</td>
  <td>Stripe</td>
  <td>Payments &amp; Payouts</td>
</tr>
<tr>
  <td>Push Notifications</td>
  <td>Firebase</td>
  <td>iOS Notifications</td>
</tr>
<tr>
  <td>Identity Verification</td>
  <td>ID.me</td>
  <td>User Verification</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="key-features">Key Features</h2>

<h3 id="implemented-features">âœ… Implemented Features</h3>

<h4 id="core-marketplace">Core Marketplace</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Browse listings with infinite scroll</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Category-based filtering</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Search functionality</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Location-based discovery</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Listing detail views</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Image galleries</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Seller profiles</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Favorites/Saved items</li>
</ul>

<h4 id="listing-management">Listing Management</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Create listings (sale/rent)</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Upload multiple images</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Edit listings</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Delete listings</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Pricing options</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Availability status</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> GPS location tagging</li>
</ul>

<h4 id="payments">Payments</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Stripe Checkout integration</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Buy Now (direct purchase)</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Secure payment processing</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Transaction history</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Stripe Connect (seller payouts)</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Payment holds</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Automatic releases</li>
</ul>

<h4 id="messaging">Messaging</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Real-time chat (Socket.IO)</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Conversation threads</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Message notifications</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Unread counts</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Chat search</li>
</ul>

<h4 id="user-management">User Management</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Registration (Email/Google/Apple)</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> JWT Authentication</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Profile customization</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Display name &amp; username</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Bio &amp; location</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Profile pictures</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> ID.me verification</li>
</ul>

<h4 id="social-features">Social Features</h4>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> User profiles</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Seller ratings</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Favorites system</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Follow system</li>
<li><input type="checkbox" class="task-list-item-checkbox" checked disabled> Activity feed</li>
</ul>

<h3 id="partially-implemented">ğŸš§ Partially Implemented</h3>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Offers system (backend ready, UI incomplete)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Reviews &amp; ratings (backend ready, UI incomplete)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Garage sales (backend ready, UI minimal)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Analytics dashboard (backend ready, UI incomplete)</li>
</ul>

<h3 id="not-implemented">âŒ Not Implemented</h3>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> In-app video calls</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Voice messages</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Product recommendations</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Referral system</li>
</ul>

<hr />

<h1 id="part-2-backend-systems-2">Part 2: Backend Systems</h1>

<h2 id="backend-architecture">Backend Architecture</h2>

<h3 id="file-structure">File Structure</h3>

<pre><code>brrow-backend/
â”œâ”€â”€ prisma-server.js          # Main server (9,981 lines)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ production.js          # Production config
â”‚   â”œâ”€â”€ database.js            # Prisma client factory
â”‚   â””â”€â”€ logger.js              # Pino logging
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ rateLimiter.js         # Rate limiting
â”‚   â”œâ”€â”€ memoryOptimization.js # Memory management
â”‚   â””â”€â”€ authentication.js      # JWT validation
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ websocket.service.js   # Socket.IO
â”‚   â”œâ”€â”€ emailService.js        # Email sending
â”‚   â”œâ”€â”€ analyticsService.js    # Analytics
â”‚   â””â”€â”€ monitoringService.js   # Health monitoring
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ search.js              # Search endpoints
â”‚   â”œâ”€â”€ admin.js               # Admin panel
â”‚   â””â”€â”€ analytics.js           # Analytics routes
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ responseTransformers.js # iOS response format
â”‚   â””â”€â”€ urlValidator.js        # URL validation
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma          # Database schema
â”œâ”€â”€ settings-system.js         # User settings
â”œâ”€â”€ stripe-connect-insurance.js # Stripe Connect
â”œâ”€â”€ blocked-users.js           # User blocking
â””â”€â”€ google-oauth.js            # Google OAuth
</code></pre>

<h3 id="server-startup-process">Server Startup Process</h3>

<p><strong>1. Database Connection</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Create optimized Prisma client with connection pooling</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">prisma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createOptimizedPrismaClient</span><span class="p">();</span>

<span class="c1">// Explicitly connect to database</span>
<span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">$connect</span><span class="p">();</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Database connected successfully&#39;</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>2. Middleware Setup</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Security</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">helmet</span><span class="p">());</span>

<span class="c1">// Compression</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">compression</span><span class="p">());</span>

<span class="c1">// Rate limiting</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">rateLimiter</span><span class="p">.</span><span class="nx">globalLimiter</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">rateLimiter</span><span class="p">.</span><span class="nx">burstLimiter</span><span class="p">());</span>

<span class="c1">// Memory optimization</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">memoryMonitor</span><span class="p">(</span><span class="mf">400</span><span class="p">));</span><span class="w"> </span><span class="c1">// 400MB alert</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connectionCleanup</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">responseSizeLimiter</span><span class="p">(</span><span class="mf">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">));</span><span class="w"> </span><span class="c1">// 5MB max</span>
</code></pre>
</div>

<p><strong>3. Routes Registration</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Core routes</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/listings&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">listingsEndpoint</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/auth/register&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">registerEndpoint</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/users/me&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="nx">getUserProfile</span><span class="p">);</span>

<span class="c1">// External modules</span>
<span class="nx">settingsSystem</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="nx">prisma</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">);</span>
<span class="nx">stripeConnect</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="nx">prisma</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">);</span>
<span class="nx">blockedUsers</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="w"> </span><span class="nx">prisma</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>4. WebSocket Initialization</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="nx">webSocketService</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">httpServer</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>5. Background Tasks</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Stats broadcasting</span>
<span class="nx">startStatsBroadcasting</span><span class="p">();</span>

<span class="c1">// Garbage collection</span>
<span class="nx">scheduleGarbageCollection</span><span class="p">();</span>

<span class="c1">// Connection cleanup</span>
<span class="nx">scheduleConnectionCleanup</span><span class="p">(</span><span class="nx">prisma</span><span class="p">);</span>

<span class="c1">// Memory monitoring</span>
<span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">logMemoryUsage</span><span class="p">(),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
</code></pre>
</div>

<hr />

<h2 id="database-schema">Database Schema</h2>

<h3 id="core-tables">Core Tables</h3>

<h4 id="users">users</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">api_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">username</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">display_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">password</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- bcrypt hashed</span>
<span class="w">  </span><span class="n">first_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">last_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">phone_number</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">phone_verified</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">profile_picture_url</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">bio</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">  </span><span class="n">date_of_birth</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_verified</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">average_rating</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="n">total_ratings</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_creator</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">creator_tier</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">stripe_account_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- For sellers</span>
<span class="w">  </span><span class="n">stripe_customer_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- For buyers</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">last_login_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">last_username_change</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>
</code></pre>
</div>

<h4 id="listings">listings</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">listings</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">description</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">price</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">daily_rate</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="n">pricing_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- &#39;sale&#39; or &#39;rent&#39;</span>
<span class="w">  </span><span class="n">category_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">categories</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">condition</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="k">location</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">  </span><span class="n">tags</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">[],</span>
<span class="w">  </span><span class="n">metadata</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">  </span><span class="n">view_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="n">favorite_count</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_premium</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">availability_status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="n">moderation_status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre>
</div>

<h4 id="listing_images">listing_images</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">listing_images</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">listing_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">listings</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">image_url</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">thumbnail_url</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_primary</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">display_order</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="n">has_gps_data</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">latitude</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">  </span><span class="n">longitude</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">  </span><span class="n">uploaded_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre>
</div>

<h4 id="purchases">purchases</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">purchases</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">buyer_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">seller_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">listing_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">listings</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">amount</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">payment_status</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- PENDING, COMPLETED, FAILED, REFUNDED</span>
<span class="w">  </span><span class="n">verification_status</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- PENDING, VERIFIED, DISPUTED</span>
<span class="w">  </span><span class="n">payment_intent_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Stripe payment intent</span>
<span class="w">  </span><span class="n">stripe_session_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Stripe checkout session</span>
<span class="w">  </span><span class="n">purchase_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- BUY_NOW, RENTAL, OFFER</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">deadline</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 7 days for verification</span>
<span class="w">  </span><span class="n">completed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="n">verified_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>
</code></pre>
</div>

<h4 id="messages">messages</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">conversation_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">sender_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">recipient_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">message_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">-- text, image, offer</span>
<span class="w">  </span><span class="n">is_read</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">read_at</span><span class="w"> </span><span class="k">TIMESTAMP</span>
<span class="p">);</span>
</code></pre>
</div>

<h4 id="favorites">favorites</h4>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">favorites</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">listing_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">listings</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="k">UNIQUE</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">listing_id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>

<h3 id="relationships">Relationships</h3>

<pre><code>users (1) â”€â”€&lt; (many) listings
users (1) â”€â”€&lt; (many) purchases (as buyer)
users (1) â”€â”€&lt; (many) purchases (as seller)
listings (1) â”€â”€&lt; (many) listing_images
listings (1) â”€â”€&lt; (many) purchases
listings (1) â”€â”€&lt; (many) favorites
categories (1) â”€â”€&lt; (many) listings
users (1) â”€â”€&lt; (many) messages (as sender)
users (1) â”€â”€&lt; (many) messages (as recipient)
</code></pre>

<hr />

<h2 id="api-endpoints">API Endpoints</h2>

<h3 id="authentication-endpoints">Authentication Endpoints</h3>

<h4 id="post-apiauthregister">POST /api/auth/register</h4>

<p><strong>Purpose</strong>: Create new user account</p>

<p><strong>Request Body</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;securePassword123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Doe&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Registration successful&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;apiId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIs...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;refreshToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIs...&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Status Codes</strong>:</p>

<ul>
<li><code>201</code>: User created successfully</li>
<li><code>400</code>: Invalid input or email already exists</li>
<li><code>500</code>: Server error</li>
</ul>

<hr />

<h4 id="post-apiauthlogin">POST /api/auth/login</h4>

<p><strong>Purpose</strong>: Authenticate user</p>

<p><strong>Request Body</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;securePassword123&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Login successful&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIs...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;refreshToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIs...&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Status Codes</strong>:</p>

<ul>
<li><code>200</code>: Login successful</li>
<li><code>401</code>: Invalid credentials</li>
<li><code>500</code>: Server error</li>
</ul>

<hr />

<h3 id="listings-endpoints">Listings Endpoints</h3>

<h4 id="get-apilistings">GET /api/listings</h4>

<p><strong>Purpose</strong>: Get all active listings</p>

<p><strong>Query Parameters</strong>:</p>

<ul>
<li><code>page</code> (number, default: 1)</li>
<li><code>limit</code> (number, default: 20, max: 100)</li>
<li><code>category</code> (string, optional)</li>
<li><code>minPrice</code> (number, optional)</li>
<li><code>maxPrice</code> (number, optional)</li>
<li><code>status</code> (string, default: 'active')</li>
<li><code>user_id</code> (string, optional) - Filter by user</li>
</ul>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;listing-id-123&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iPhone 15 Pro&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Brand new, sealed&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;categoryId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electronics&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;userId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-id-456&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NEW&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;city&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;San Francisco&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;zipCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;94102&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;images&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;img-1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;imageUrl&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://res.cloudinary.com/...&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;isPrimary&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;displayOrder&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-id-456&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;profile_picture_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://...&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;category&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electronics&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Electronics&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;icon_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ğŸ“±&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;pagination&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;page&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;per_page&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;total_pages&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;has_more&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h4 id="get-apilistingsid">GET /api/listings/:id</h4>

<p><strong>Purpose</strong>: Get single listing details</p>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;listing-id-123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iPhone 15 Pro&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Detailed description...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dailyRate&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;pricingType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sale&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NEW&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;viewCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;favoriteCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;isActive&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;availabilityStatus&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AVAILABLE&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;images&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;category&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-01T12:00:00Z&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h4 id="post-apilistings">POST /api/listings</h4>

<p><strong>Purpose</strong>: Create new listing (requires authentication)</p>

<p><strong>Headers</strong>:</p>

<pre><code>Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
</code></pre>

<p><strong>Request Body</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iPhone 15 Pro&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Brand new, sealed in box&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;pricingType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sale&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;categoryId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;electronics&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NEW&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;city&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;San Francisco&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;zipCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;94102&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;latitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">37.7749</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;longitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">-122.4194</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;images&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;https://res.cloudinary.com/brrow/image/upload/v.../image1.jpg&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;https://res.cloudinary.com/brrow/image/upload/v.../image2.jpg&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;smartphone&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;apple&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ios&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;deliveryOptions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;pickup&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;delivery&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;shipping&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Listing created successfully&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;listing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;new-listing-id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iPhone 15 Pro&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Status Codes</strong>:</p>

<ul>
<li><code>201</code>: Listing created</li>
<li><code>400</code>: Invalid input</li>
<li><code>401</code>: Not authenticated</li>
<li><code>500</code>: Server error</li>
</ul>

<hr />

<h3 id="user-endpoints">User Endpoints</h3>

<h4 id="get-apiusersme">GET /api/users/me</h4>

<p><strong>Purpose</strong>: Get current user profile (requires authentication)</p>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;displayName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John D.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;profilePictureUrl&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;bio&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tech enthusiast&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;phoneNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;+1234567890&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;phoneVerified&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;San Francisco, CA&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isVerified&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;averageRating&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">4.8</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;totalRatings&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-15T10:30:00Z&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h4 id="put-apiusersme">PUT /api/users/me</h4>

<p><strong>Purpose</strong>: Update user profile (requires authentication)</p>

<p><strong>Request Body</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Doe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;displayName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Johnny&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;bio&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Updated bio&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;San Francisco, CA&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;website&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://johndoe.com&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;displayName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Johnny&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="err">...</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Important Notes</strong>:</p>

<ul>
<li>âœ… <strong>Display name</strong> can be updated anytime</li>
<li>âš ï¸ <strong>Username</strong> can only be changed once every 90 days</li>
<li>âš ï¸ <strong>Phone number</strong> requires SMS verification (use <code>/api/verify/send-sms</code>)</li>
</ul>

<hr />

<h3 id="purchase-endpoints">Purchase Endpoints</h3>

<h4 id="post-apipurchases">POST /api/purchases</h4>

<p><strong>Purpose</strong>: Create purchase and Stripe checkout session</p>

<p><strong>Request Body</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;listing_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;listing-id-123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;purchase_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BUY_NOW&quot;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Response</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Purchase created - please complete checkout&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;needsPaymentMethod&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;checkoutUrl&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://checkout.stripe.com/c/pay/cs_test_...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;sessionId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cs_test_...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;purchase&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;purchase-id-789&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;buyer_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-id-456&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;seller_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-id-123&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;listing_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;listing-id-123&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;payment_status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PENDING&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;verification_status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PENDING&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-08T10:30:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;deadline&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-15T10:30:00Z&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Flow</strong>:</p>

<ol>
<li>Backend creates purchase record</li>
<li>Backend creates Stripe checkout session</li>
<li>Returns checkout URL</li>
<li>iOS app opens URL in SafariViewController</li>
<li>User completes payment on Stripe</li>
<li>Stripe redirects to <code>brrowapp://stripe/success</code></li>
<li>Stripe sends webhook to backend</li>
<li>Backend updates purchase status to <code>COMPLETED</code></li>
</ol>

<hr />

<h2 id="authentication-security">Authentication &amp; Security</h2>

<h3 id="jwt-token-system">JWT Token System</h3>

<p><strong>Access Token</strong> (1 hour expiry):</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;userId&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;johndoe&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;iat&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1633024800</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;exp&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1633028400</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Refresh Token</strong> (30 days expiry):</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;userId&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cmf123...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;iat&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1633024800</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;exp&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1635616800</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="authentication-flow">Authentication Flow</h3>

<pre><code>1. User logs in
   â†“
2. Backend validates credentials
   â†“
3. Backend generates JWT tokens
   â†“
4. iOS stores tokens in Keychain
   â†“
5. iOS includes token in Authorization header
   â†“
6. Backend validates token on each request
   â†“
7. If expired, iOS uses refresh token
</code></pre>

<h3 id="token-storage-ios">Token Storage (iOS)</h3>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Keychain storage</span>
<span class="n">KeychainHelper</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">forKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;authToken&quot;</span><span class="p">)</span>
<span class="n">KeychainHelper</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">refreshToken</span><span class="p">,</span><span class="w"> </span><span class="n">forKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;refreshToken&quot;</span><span class="p">)</span>

<span class="c1">// Usage</span>
<span class="kd">let</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">KeychainHelper</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;authToken&quot;</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="s">&quot;Bearer </span><span class="si">\(</span><span class="n">token</span><span class="si">)</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">forHTTPHeaderField</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Authorization&quot;</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="security-measures">Security Measures</h3>

<h4 id="rate-limiting">Rate Limiting</h4>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Global rate limit: 100 requests per 15 minutes</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">rateLimiter</span><span class="p">.</span><span class="nx">globalLimiter</span><span class="p">());</span>

<span class="c1">// Burst protection: 10 requests per second</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">rateLimiter</span><span class="p">.</span><span class="nx">burstLimiter</span><span class="p">());</span>

<span class="c1">// API-specific limits</span>
<span class="err">/api/auth/login: 5 requests per 15 minutes</span>
<span class="err">/api/listings: 60 requests per minute</span>
<span class="err">/api/messages: 120 requests per minute</span>
</code></pre>
</div>

<h4 id="security-headers-helmetjs">Security Headers (Helmet.js)</h4>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">contentSecurityPolicy</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">xssFilter</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">noSniff</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ieNoOpen</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">hsts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">maxAge</span><span class="o">:</span><span class="w"> </span><span class="mf">31536000</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="password-security">Password Security</h4>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Bcrypt with 10 salt rounds</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hashedPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>

<span class="c1">// Password requirements</span>
<span class="o">-</span><span class="w"> </span><span class="nx">Minimum</span><span class="w"> </span><span class="mf">8</span><span class="w"> </span><span class="nx">characters</span>
<span class="o">-</span><span class="w"> </span><span class="nx">At</span><span class="w"> </span><span class="nx">least</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="nx">uppercase</span><span class="w"> </span><span class="nx">letter</span>
<span class="o">-</span><span class="w"> </span><span class="nx">At</span><span class="w"> </span><span class="nx">least</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="nx">lowercase</span><span class="w"> </span><span class="nx">letter</span>
<span class="o">-</span><span class="w"> </span><span class="nx">At</span><span class="w"> </span><span class="nx">least</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="nx">number</span>
</code></pre>
</div>

<hr />

<h1 id="part-3-ios-application-2">Part 3: iOS Application</h1>

<h2 id="ios-architecture">iOS Architecture</h2>

<h3 id="mvvm-pattern">MVVM Pattern</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Views (SwiftUI)             â”‚
â”‚  - Declarative UI                        â”‚
â”‚  - Reactive to state changes             â”‚
â”‚  - No business logic                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ Binds to @Published vars
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ViewModels (ObservableObject)    â”‚
â”‚  - Business logic                        â”‚
â”‚  - State management                      â”‚
â”‚  - API calls                             â”‚
â”‚  - Data transformation                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ Uses
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Models (Codable)              â”‚
â”‚  - Data structures                       â”‚
â”‚  - JSON decoding/encoding                â”‚
â”‚  - Immutable data                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<h3 id="project-structure">Project Structure</h3>

<pre><code>Brrow/
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Listing.swift
â”‚   â”œâ”€â”€ User.swift
â”‚   â”œâ”€â”€ Message.swift
â”‚   â””â”€â”€ Purchase.swift
â”œâ”€â”€ ViewModels/
â”‚   â”œâ”€â”€ MarketplaceViewModel.swift
â”‚   â”œâ”€â”€ ListingDetailViewModel.swift
â”‚   â”œâ”€â”€ MyPostsViewModel.swift
â”‚   â””â”€â”€ ChatViewModel.swift
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ ProfessionalMarketplaceView.swift
â”‚   â”œâ”€â”€ ProfessionalListingDetailView.swift
â”‚   â”œâ”€â”€ ModernCreateListingView.swift
â”‚   â”œâ”€â”€ EnhancedChatDetailView.swift
â”‚   â””â”€â”€ SimpleProfessionalProfileView.swift
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ APIClient.swift
â”‚   â”œâ”€â”€ AuthenticationService.swift
â”‚   â”œâ”€â”€ ListingNavigationManager.swift
â”‚   â”œâ”€â”€ ImageCacheService.swift
â”‚   â””â”€â”€ AppOptimizationService.swift
â”œâ”€â”€ Components/
â”‚   â”œâ”€â”€ BrrowAsyncImage.swift
â”‚   â”œâ”€â”€ ListingGridCard.swift
â”‚   â””â”€â”€ ModernTextFieldComponents.swift
â””â”€â”€ BrrowApp.swift (Entry point)
</code></pre>

<hr />

<h2 id="navigation-system">Navigation System</h2>

<h3 id="listingnavigationmanager">ListingNavigationManager</h3>

<p><strong>Purpose</strong>: Centralized navigation for listing detail views</p>

<p><strong>Key Features</strong>:</p>

<ul>
<li>âœ… Single source of truth for listing navigation</li>
<li>âœ… Supports both Listing object and ID-based navigation</li>
<li>âœ… Handles loading states</li>
<li>âœ… Works from any view in the app</li>
<li>âœ… Prevents duplicate sheets</li>
</ul>

<p><strong>Usage</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Navigate with Listing object</span>
<span class="n">ListingNavigationManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">showListing</span><span class="p">(</span><span class="n">listing</span><span class="p">)</span>

<span class="c1">// Navigate with ID (will load listing)</span>
<span class="n">ListingNavigationManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">showListingById</span><span class="p">(</span><span class="s">&quot;listing-id-123&quot;</span><span class="p">)</span>

<span class="c1">// Clear navigation</span>
<span class="n">ListingNavigationManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">clearListing</span><span class="p">()</span>
</code></pre>
</div>

<p><strong>Implementation</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">ListingNavigationManager</span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">shared</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ListingNavigationManager</span><span class="p">()</span>

<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">selectedListing</span><span class="p">:</span><span class="w"> </span><span class="n">Listing</span><span class="p">?</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">showingListingDetail</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">pendingListingId</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">?</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">isLoadingListing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">showListing</span><span class="p">(</span><span class="kc">_</span><span class="w"> </span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">Listing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pendingListingId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="n">selectedListing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">listing</span>
<span class="w">        </span><span class="n">showingListingDetail</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">showListingById</span><span class="p">(</span><span class="kc">_</span><span class="w"> </span><span class="n">listingId</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pendingListingId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">listingId</span>
<span class="w">        </span><span class="n">showingListingDetail</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="n">loadListing</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="n">listingId</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>View Modifier</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">extension</span><span class="w"> </span><span class="nc">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">withUniversalListingDetail</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">modifier</span><span class="p">(</span><span class="n">UniversalListingDetailModifier</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Usage in root view</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">body</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TabView</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">.</span><span class="n">withUniversalListingDetail</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Important Fix</strong>: SwiftUI reuses views by default. To force recreation when listing changes:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">.</span><span class="n">sheet</span><span class="p">(</span><span class="n">isPresented</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">navigationManager</span><span class="p">.</span><span class="n">showingListingDetail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">listing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">navigationManager</span><span class="p">.</span><span class="n">selectedListing</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">NavigationView</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ProfessionalListingDetailView</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="n">id</span><span class="p">(</span><span class="n">listing</span><span class="p">.</span><span class="n">listingId</span><span class="p">)</span><span class="w"> </span><span class="c1">// â† Forces view recreation</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2 id="state-management">State Management</h2>

<h3 id="stateobject-vs-observedobject">@StateObject vs @ObservedObject</h3>

<p><strong>@StateObject</strong>: View owns the object (creates it)</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">struct</span><span class="w"> </span><span class="nc">MarketplaceView</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">@</span><span class="n">StateObject</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">viewModel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">MarketplaceViewModel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>@ObservedObject</strong>: View observes external object</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">struct</span><span class="w"> </span><span class="nc">ListingCard</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">@</span><span class="n">ObservedObject</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">viewModel</span><span class="p">:</span><span class="w"> </span><span class="n">MarketplaceViewModel</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="published-properties">@Published Properties</h3>

<p><strong>ViewModel Example</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">MarketplaceViewModel</span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">listings</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">Listing</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">isLoading</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">errorMessage</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">?</span>
<span class="w">    </span><span class="p">@</span><span class="n">Published</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">selectedCategory</span><span class="p">:</span><span class="w"> </span><span class="n">Category</span><span class="p">?</span>

<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">fetchListings</span><span class="p">()</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">isLoading</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">fetchListings</span><span class="p">()</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">MainActor</span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kc">self</span><span class="p">.</span><span class="n">listings</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">listings</span>
<span class="w">                </span><span class="kc">self</span><span class="p">.</span><span class="n">isLoading</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">MainActor</span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kc">self</span><span class="p">.</span><span class="n">errorMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span>
<span class="w">                </span><span class="kc">self</span><span class="p">.</span><span class="n">isLoading</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2 id="ui-components">UI Components</h2>

<h3 id="brrowasyncimage">BrrowAsyncImage</h3>

<p><strong>Purpose</strong>: Optimized async image loading with caching</p>

<p><strong>Features</strong>:</p>

<ul>
<li>âœ… Automatic Cloudinary URL handling</li>
<li>âœ… Memory caching via SDWebImage</li>
<li>âœ… Placeholder support</li>
<li>âœ… Error handling</li>
<li>âœ… Retry logic</li>
</ul>

<p><strong>Usage</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">BrrowAsyncImage</span><span class="p">(</span>
<span class="w">    </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">.</span><span class="n">primaryImageUrl</span><span class="p">,</span>
<span class="w">    </span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span>
<span class="w">    </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span>
<span class="p">)</span>
<span class="p">.</span><span class="n">cornerRadius</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>Implementation</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">struct</span><span class="w"> </span><span class="nc">BrrowAsyncImage</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">url</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">?</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">width</span><span class="p">:</span><span class="w"> </span><span class="n">CGFloat</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">height</span><span class="p">:</span><span class="w"> </span><span class="n">CGFloat</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">body</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">imageUrl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">processedURL</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">WebImage</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span><span class="w"> </span><span class="n">imageUrl</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="n">resizable</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">placeholder</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Color</span><span class="p">.</span><span class="n">gray</span><span class="p">.</span><span class="n">opacity</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="p">.</span><span class="n">indicator</span><span class="p">(.</span><span class="n">activity</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">transition</span><span class="p">(.</span><span class="n">fade</span><span class="p">(</span><span class="n">duration</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="n">scaledToFill</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">clipped</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Color</span><span class="p">.</span><span class="n">gray</span><span class="p">.</span><span class="n">opacity</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h1 id="part-4-third-party-integrations-2">Part 4: Third-Party Integrations</h1>

<h2 id="stripe-payment-system">Stripe Payment System</h2>

<h3 id="setup">Setup</h3>

<p><strong>Dashboard</strong>: https://dashboard.stripe.com</p>

<p><strong>API Keys</strong>:</p>

<ul>
<li><strong>Test Mode</strong>:
<ul>
<li><code>pk_test_...</code> (Publishable)</li>
<li><code>sk_test_...</code> (Secret)</li>
</ul></li>
<li><strong>Live Mode</strong>:
<ul>
<li><code>pk_live_...</code> (Publishable)</li>
<li><code>sk_live_...</code> (Secret)</li>
</ul></li>
</ul>

<p><strong>Environment Variables</strong> (Railway):</p>

<div class="codehilite">
<pre><span></span><code><span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span>sk_test_...<span class="w">  </span><span class="c1"># or sk_live_...</span>
<span class="nv">STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span>pk_test_...<span class="w">  </span><span class="c1"># or pk_live_...</span>
<span class="nv">STRIPE_WEBHOOK_SECRET</span><span class="o">=</span>whsec_...
</code></pre>
</div>

<h3 id="test-vs-live-mode">Test vs Live Mode</h3>

<p><strong>Switching Between Modes</strong>:</p>

<ol>
<li>Update Railway variables with test keys â†’ Test mode</li>
<li>Update Railway variables with live keys â†’ Live mode</li>
<li>Railway auto-restarts (2 minutes)</li>
<li>All new transactions use the new mode</li>
</ol>

<p><strong>âš ï¸ IMPORTANT: Your System is Currently in LIVE Mode</strong></p>

<p>Based on transaction logs showing <code>cs_live_...</code> session IDs, your production system is using <strong>live Stripe keys</strong>. This means:</p>

<ul>
<li>âœ… Real payments are being processed</li>
<li>âœ… Real money is being charged</li>
<li>âš ï¸ You should switch to test mode for development/testing</li>
</ul>

<p><strong>How to Switch to Test Mode</strong> (Step-by-Step):</p>

<ol>
<li><p><strong>Get Your Test Keys</strong> from Stripe Dashboard:</p>

<ul>
<li>Go to: https://dashboard.stripe.com/test/apikeys</li>
<li>Copy <strong>Publishable key</strong> (starts with <code>pk_test_...</code>)</li>
<li>Copy <strong>Secret key</strong> (starts with <code>sk_test_...</code>)</li>
</ul></li>
<li><p><strong>Update Railway Environment Variables</strong>:</p>

<ul>
<li>Go to: https://railway.app</li>
<li>Select service: <code>brrow-backend-nodejs-production</code></li>
<li>Click "Variables" tab</li>
<li>Find <code>STRIPE_SECRET_KEY</code> â†’ Click to edit</li>
<li>Paste your test secret key: <code>sk_test_...</code></li>
<li>Find <code>STRIPE_PUBLISHABLE_KEY</code> â†’ Click to edit</li>
<li>Paste your test publishable key: <code>pk_test_...</code></li>
<li>Railway will auto-restart (wait 2 minutes)</li>
</ul></li>
<li><p><strong>Verify Test Mode is Active</strong>:</p>

<ul>
<li>Make a test purchase in iOS app</li>
<li>Check checkout URL contains: <code>cs_test_...</code> (not <code>cs_live_...</code>)</li>
<li>View transaction in Stripe Test Dashboard (not Live Dashboard)</li>
</ul></li>
</ol>

<p><strong>What Changes in Test Mode</strong>:</p>

<ul>
<li>âœ… All new checkout sessions use <code>cs_test_...</code> prefix</li>
<li>âœ… All new payments are test transactions (no real charges)</li>
<li>âœ… All new webhooks are test events</li>
<li>âœ… Database stores test purchase records</li>
<li>âœ… Stripe dashboard shows test data only</li>
<li>âœ… Backend code unchanged (same code works for both modes)</li>
<li>âœ… iOS app unchanged (just uses whatever backend provides)</li>
</ul>

<p><strong>What DOESN'T Change</strong>:</p>

<ul>
<li>âŒ Old live purchase records in database (they stay)</li>
<li>âŒ Old live transactions in Stripe (they stay)</li>
<li>âŒ Any code (backend or iOS)</li>
</ul>

<p><strong>Test Mode Characteristics</strong>:</p>

<ul>
<li>âœ… No real money is charged - EVER</li>
<li>âœ… Use test card: <code>4242 4242 4242 4242</code></li>
<li>âœ… Checkout URLs have <code>cs_test_...</code> prefix</li>
<li>âœ… Transactions visible in Test Dashboard only</li>
<li>âœ… Database records are test data (safe to delete)</li>
<li>âœ… Unlimited free testing</li>
</ul>

<p><strong>Test Cards</strong>:</p>

<table>
<thead>
<tr>
  <th>Card Number</th>
  <th>Scenario</th>
</tr>
</thead>
<tbody>
<tr>
  <td>4242 4242 4242 4242</td>
  <td>âœ… Success</td>
</tr>
<tr>
  <td>4000 0000 0000 9995</td>
  <td>âŒ Insufficient funds</td>
</tr>
<tr>
  <td>4000 0000 0000 0002</td>
  <td>âŒ Card declined</td>
</tr>
<tr>
  <td>4000 0000 0000 0341</td>
  <td>âš ï¸ Requires 3D Secure</td>
</tr>
</tbody>
</table>

<p><strong>Test Card Details</strong> (use with any test card):</p>

<ul>
<li>Expiry: Any future date (e.g., <code>12/34</code>)</li>
<li>CVC: Any 3 digits (e.g., <code>123</code>)</li>
<li>ZIP: Any 5 digits (e.g., <code>12345</code>)</li>
<li>Name: Any name</li>
</ul>

<hr />

<h3 id="buy-now-flow">Buy Now Flow</h3>

<p><strong>Complete Payment Flow</strong>:</p>

<pre><code>1. User taps "Buy Now" in iOS app
   â†“
2. iOS calls POST /api/purchases
   {
     "listing_id": "...",
     "amount": 999,
     "purchase_type": "BUY_NOW"
   }
   â†“
3. Backend creates purchase record (status: PENDING)
   â†“
4. Backend creates Stripe Checkout Session
   stripe.checkout.sessions.create({
     mode: 'payment',
     line_items: [{
       price_data: {
         currency: 'usd',
         product_data: { name: listing.title },
         unit_amount: amount * 100
       },
       quantity: 1
     }],
     success_url: 'brrowapp://stripe/success?session_id={CHECKOUT_SESSION_ID}',
     cancel_url: 'brrowapp://stripe/cancel'
   })
   â†“
5. Backend returns checkout URL
   {
     "checkoutUrl": "https://checkout.stripe.com/c/pay/cs_test_...",
     "sessionId": "cs_test_...",
     "purchase": { "id": "...", "payment_status": "PENDING" }
   }
   â†“
6. iOS opens checkout URL in SafariViewController
   â†“
7. User enters card info and completes payment on Stripe
   â†“
8. Stripe redirects to: brrowapp://stripe/success?session_id=cs_test_...
   â†“
9. iOS app handles deep link
   â†“
10. Stripe sends webhook to backend
    POST /api/stripe/webhook
    Event: checkout.session.completed
   â†“
11. Backend verifies webhook signature
   â†“
12. Backend updates purchase:
    payment_status = 'COMPLETED'
    payment_intent_id = pi_...
    stripe_session_id = cs_test_...
   â†“
13. Backend holds funds for 7 days (verification period)
   â†“
14. After 7 days OR buyer confirms:
    - Backend releases payment to seller
    - Updates verification_status = 'VERIFIED'
</code></pre>

<p><strong>Backend Code</strong> (<code>prisma-server.js</code>):</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/purchases&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">listing_id</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">purchase_type</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create purchase record</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">purchase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">seller_id</span><span class="o">:</span><span class="w"> </span><span class="nx">listing</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">listing_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">payment_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">verification_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">purchase_type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">deadline</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="c1">// 7 days</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Create Stripe checkout session</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">checkout</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;payment&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">payment_method_types</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;card&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">line_items</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nx">price_data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">product_data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">listing</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">unit_amount</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="c1">// Convert to cents</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">}],</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">purchase_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">seller_id</span><span class="o">:</span><span class="w"> </span><span class="nx">listing</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">listing_id</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">success_url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;brrowapp://stripe/success?session_id={CHECKOUT_SESSION_ID}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">cancel_url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;brrowapp://stripe/cancel&#39;</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">needsPaymentMethod</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">checkoutUrl</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sessionId</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">purchase</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>iOS Code</strong> (BuyNowHandler.swift):</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nf">handleBuyNow</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">Listing</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="nb">Double</span><span class="p">)</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kr">throws</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Create purchase</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">createPurchase</span><span class="p">(</span>
<span class="w">        </span><span class="n">listingId</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">.</span><span class="n">listingId</span><span class="p">,</span>
<span class="w">        </span><span class="n">amount</span><span class="p">:</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span>
<span class="w">        </span><span class="n">purchaseType</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;BUY_NOW&quot;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 2. Open Stripe checkout</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">checkoutUrl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">checkoutUrl</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">MainActor</span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kc">self</span><span class="p">.</span><span class="n">showingCheckout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="kc">self</span><span class="p">.</span><span class="n">checkoutURL</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span><span class="w"> </span><span class="n">checkoutUrl</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Webhook Handler</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/stripe/webhook&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">raw</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">}),</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;stripe-signature&#39;</span><span class="p">];</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">webhooks</span><span class="p">.</span><span class="nx">constructEvent</span><span class="p">(</span>
<span class="w">      </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sig</span><span class="p">,</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRIPE_WEBHOOK_SECRET</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;checkout.session.completed&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Update purchase</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">        </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">purchase_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">payment_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">payment_intent_id</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">payment_intent</span><span class="p">,</span>
<span class="w">          </span><span class="nx">stripe_session_id</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Mark listing as pending</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">        </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">listing_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">availability_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nx">received</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="sb">`Webhook Error: </span><span class="si">${</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h2 id="stripe-connect-seller-payments">Stripe Connect (Seller Payments)</h2>

<h3 id="purpose">Purpose</h3>

<p>Allows sellers to receive payments directly to their bank accounts.</p>

<h3 id="setup-flow">Setup Flow</h3>

<p><strong>1. Seller Clicks "Connect Stripe"</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// iOS calls backend</span>
<span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">createStripeConnectAccount</span><span class="p">()</span>
</code></pre>
</div>

<p><strong>2. Backend Creates Connected Account</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/stripe/connect/create&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Create Stripe Connect account</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;express&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">country</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;US&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
<span class="w">    </span><span class="nx">capabilities</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">card_payments</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">requested</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span>
<span class="w">      </span><span class="nx">transfers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">requested</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Save to database</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripe_account_id</span><span class="o">:</span><span class="w"> </span><span class="nx">account</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Create onboarding link</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accountLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">accountLinks</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">account</span><span class="o">:</span><span class="w"> </span><span class="nx">account</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refresh_url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;brrowapp://stripe-connect/refresh&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">return_url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;brrowapp://stripe-connect/success&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;account_onboarding&#39;</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">onboardingUrl</span><span class="o">:</span><span class="w"> </span><span class="nx">accountLink</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
<span class="w">    </span><span class="nx">accountId</span><span class="o">:</span><span class="w"> </span><span class="nx">account</span><span class="p">.</span><span class="nx">id</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>3. iOS Opens Onboarding URL</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Stripe hosts the onboarding form</span>
<span class="c1">// User enters bank details, tax info, etc.</span>
<span class="c1">// Stripe handles all compliance</span>
</code></pre>
</div>

<p><strong>4. User Completes Onboarding</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Stripe redirects to: brrowapp://stripe-connect/success</span>
<span class="c1">// iOS handles deep link</span>
<span class="c1">// Backend verifies account is fully onboarded</span>
</code></pre>
</div>

<h3 id="payout-flow">Payout Flow</h3>

<p><strong>When buyer verifies purchase</strong> (after 7 days OR manual confirmation):</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Backend automatically transfers funds to seller</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">transfer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">transfers</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">  </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.90</span><span class="p">),</span><span class="w"> </span><span class="c1">// 90% to seller (10% platform fee)</span>
<span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="nx">seller</span><span class="p">.</span><span class="nx">stripe_account_id</span><span class="p">,</span>
<span class="w">  </span><span class="nx">transfer_group</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">purchase_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">listing_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">listing_id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">buyer_id</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">  </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">verification_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;VERIFIED&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">verified_at</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>Payout Schedule</strong>:</p>

<ul>
<li>Stripe automatically pays out to seller's bank</li>
<li>Default: 2 business days</li>
<li>Seller can view payouts in Stripe Dashboard</li>
</ul>

<hr />

<h2 id="firebase-services">Firebase Services</h2>

<h3 id="firebase-authentication">Firebase Authentication</h3>

<p><strong>Providers</strong>:</p>

<ul>
<li>Email/Password</li>
<li>Google Sign-In</li>
<li>Apple Sign-In</li>
</ul>

<p><strong>iOS Setup</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// GoogleService-Info.plist in project</span>
<span class="c1">// Firebase SDK initialization in BrrowApp.swift</span>
<span class="kd">import</span><span class="w"> </span><span class="nc">Firebase</span>

<span class="p">@</span><span class="n">main</span>
<span class="kd">struct</span><span class="w"> </span><span class="nc">BrrowApp</span><span class="p">:</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">FirebaseApp</span><span class="p">.</span><span class="n">configure</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Google Sign-In Flow</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nf">signInWithGoogle</span><span class="p">()</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kr">throws</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Get ID token from Google</span>
<span class="w">    </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">idToken</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">googleUser</span><span class="p">.</span><span class="n">authentication</span><span class="p">.</span><span class="n">idToken</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">AuthError</span><span class="p">.</span><span class="n">noIDToken</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. Send to backend</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">googleSignIn</span><span class="p">(</span><span class="n">idToken</span><span class="p">:</span><span class="w"> </span><span class="n">idToken</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 3. Save tokens</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">KeychainHelper</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">forKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;authToken&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 4. Update app state</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">MainActor</span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kc">self</span><span class="p">.</span><span class="n">isAuthenticated</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Backend Integration</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/auth/google-signin&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idToken</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Verify token with Google</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ticket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">googleClient</span><span class="p">.</span><span class="nx">verifyIdToken</span><span class="p">({</span>
<span class="w">    </span><span class="nx">idToken</span><span class="p">,</span>
<span class="w">    </span><span class="nx">audience</span><span class="o">:</span><span class="w"> </span><span class="nx">GOOGLE_CLIENT_ID</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ticket</span><span class="p">.</span><span class="nx">getPayload</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Find or create user</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">email</span><span class="p">,</span>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">generateUsername</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
<span class="w">        </span><span class="nx">first_name</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">given_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">last_name</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">family_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">profile_picture_url</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">picture</span><span class="p">,</span>
<span class="w">        </span><span class="nx">is_verified</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">email_verified</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Generate JWT</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">JWT_SECRET</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1h&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="firebase-cloud-messaging-push-notifications">Firebase Cloud Messaging (Push Notifications)</h3>

<p><strong>iOS Setup</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Request permission</span>
<span class="bp">UNUserNotificationCenter</span><span class="p">.</span><span class="n">current</span><span class="p">().</span><span class="n">requestAuthorization</span><span class="p">(</span><span class="n">options</span><span class="p">:</span><span class="w"> </span><span class="p">[.</span><span class="n">alert</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">badge</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">sound</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">granted</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">granted</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">UIApplication</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">registerForRemoteNotifications</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Handle token</span>
<span class="kd">func</span><span class="w"> </span><span class="nf">application</span><span class="p">(</span><span class="kc">_</span><span class="w"> </span><span class="n">application</span><span class="p">:</span><span class="w"> </span><span class="bp">UIApplication</span><span class="p">,</span><span class="w"> </span><span class="n">didRegisterForRemoteNotificationsWithDeviceToken</span><span class="w"> </span><span class="n">deviceToken</span><span class="p">:</span><span class="w"> </span><span class="n">Data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Convert to string</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">deviceToken</span><span class="p">.</span><span class="bp">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;%02.2hhx&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">$0</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">joined</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Send to backend</span>
<span class="w">    </span><span class="n">Task</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">updateFCMToken</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Backend Storage</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/users/me/fcm-token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fcmToken</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fcm_token</span><span class="o">:</span><span class="w"> </span><span class="nx">fcmToken</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>Sending Notifications</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;firebase-admin&#39;</span><span class="p">);</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendNotification</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fcm_token</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">fcm_token</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">notification</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="p">,</span>
<span class="w">    </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">fcm_token</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">messaging</span><span class="p">().</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Example: New message notification</span>
<span class="k">await</span><span class="w"> </span><span class="nx">sendNotification</span><span class="p">(</span>
<span class="w">  </span><span class="nx">recipientId</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;New Message&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="sb">`</span><span class="si">${</span><span class="nx">senderUsername</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">messagePreview</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;new_message&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">conversation_id</span><span class="o">:</span><span class="w"> </span><span class="nx">conversationId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sender_id</span><span class="o">:</span><span class="w"> </span><span class="nx">senderId</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">);</span>
</code></pre>
</div>

<hr />

<h2 id="cloudinary-image-storage">Cloudinary (Image Storage)</h2>

<h3 id="configuration">Configuration</h3>

<p><strong>Environment Variables</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nv">CLOUDINARY_CLOUD_NAME</span><span class="o">=</span>brrow
<span class="nv">CLOUDINARY_API_KEY</span><span class="o">=</span><span class="m">918121214196197</span>
<span class="nv">CLOUDINARY_API_SECRET</span><span class="o">=</span>_uv_x8ku7vRhFN7Z0Ko61xibqYY
</code></pre>
</div>

<p><strong>Backend Setup</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">cloudinary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cloudinary&#39;</span><span class="p">).</span><span class="nx">v2</span><span class="p">;</span>

<span class="nx">cloudinary</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
<span class="w">  </span><span class="nx">cloud_name</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLOUDINARY_CLOUD_NAME</span><span class="p">,</span>
<span class="w">  </span><span class="nx">api_key</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLOUDINARY_API_KEY</span><span class="p">,</span>
<span class="w">  </span><span class="nx">api_secret</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLOUDINARY_API_SECRET</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="upload-flow">Upload Flow</h3>

<p><strong>iOS â†’ Backend</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// 1. User picks image</span>
<span class="kd">let</span><span class="w"> </span><span class="nv">image</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="bp">UIImage</span><span class="p">(...)</span>

<span class="c1">// 2. Convert to base64</span>
<span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">imageData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">jpegData</span><span class="p">(</span><span class="n">compressionQuality</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span>
<span class="kd">let</span><span class="w"> </span><span class="nv">base64String</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">imageData</span><span class="p">.</span><span class="n">base64EncodedString</span><span class="p">()</span>

<span class="c1">// 3. Send to backend</span>
<span class="kd">let</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">uploadImage</span><span class="p">(</span><span class="n">base64</span><span class="p">:</span><span class="w"> </span><span class="n">base64String</span><span class="p">)</span>
<span class="c1">// Returns: { &quot;url&quot;: &quot;https://res.cloudinary.com/brrow/image/upload/v.../image.jpg&quot; }</span>
</code></pre>
</div>

<p><strong>Backend Upload</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">uploadToCloudinary</span><span class="p">(</span><span class="nx">base64Data</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;brrow&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Add data URI prefix if missing</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">base64Data</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">base64Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`data:image/jpeg;base64,</span><span class="si">${</span><span class="nx">base64Data</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">cloudinary</span><span class="p">.</span><span class="nx">uploader</span><span class="p">.</span><span class="nx">upload</span><span class="p">(</span><span class="nx">base64Data</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="nx">folder</span><span class="p">,</span>
<span class="w">    </span><span class="nx">resource_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">quality</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">transformation</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">crop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">quality</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auto:good&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">secure_url</span><span class="p">,</span>
<span class="w">    </span><span class="nx">public_id</span><span class="o">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">public_id</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>URL Format</strong>:</p>

<pre><code>https://res.cloudinary.com/brrow/image/upload/v1759731593/brrow/uploads/1759731593301-txtbrok.jpg
                              â””â”€ cloud    â””â”€ folder    â””â”€ timestamp  â””â”€ filename
</code></pre>

<h3 id="image-transformations">Image Transformations</h3>

<p><strong>Cloudinary automatically optimizes</strong>:</p>

<ul>
<li>Format: WebP (for browsers that support it)</li>
<li>Quality: Auto-adjusted based on content</li>
<li>Size: Responsive sizes</li>
<li>Compression: Intelligent compression</li>
</ul>

<p><strong>Manual transformations</strong> (via URL):</p>

<pre><code>// Original
https://res.cloudinary.com/brrow/image/upload/v.../image.jpg

// 300x300 thumbnail
https://res.cloudinary.com/brrow/image/upload/w_300,h_300,c_fill/v.../image.jpg

// Blur effect
https://res.cloudinary.com/brrow/image/upload/e_blur:400/v.../image.jpg

// Grayscale
https://res.cloudinary.com/brrow/image/upload/e_grayscale/v.../image.jpg
</code></pre>

<hr />

<h2 id="idme-verification">ID.me Verification</h2>

<h3 id="purpose-2">Purpose</h3>

<p>Government-issued ID verification for user trust and safety.</p>

<h3 id="configuration-2">Configuration</h3>

<p><strong>Environment Variables</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nv">IDME_CLIENT_ID</span><span class="o">=</span>02ef5aa6d4b40536a8cb82b7b902aba4
<span class="nv">IDME_CLIENT_SECRET</span><span class="o">=</span>d79736fd19dd7960b40d4a342fd56876
<span class="nv">IDME_REDIRECT_URI</span><span class="o">=</span>https://brrow-backend-nodejs-production.up.railway.app/brrow/idme/callback
</code></pre>
</div>

<h3 id="verification-flow">Verification Flow</h3>

<p><strong>1. User Initiates Verification</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// iOS opens URL in Safari</span>
<span class="kd">let</span><span class="w"> </span><span class="nv">authURL</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;https://brrow-backend-nodejs-production.up.railway.app/brrow/idme/auth&quot;</span>
<span class="bp">UIApplication</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span><span class="w"> </span><span class="n">authURL</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>2. Backend Redirects to ID.me</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/brrow/idme/auth&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">authUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://api.id.me/oauth/authorize?`</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="sb">`client_id=</span><span class="si">${</span><span class="nx">IDME_CLIENT_ID</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="sb">`&amp;redirect_uri=</span><span class="si">${</span><span class="nx">IDME_REDIRECT_URI</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="sb">`&amp;response_type=code`</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="sb">`&amp;scope=military`</span><span class="p">;</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">authUrl</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>3. User Completes ID.me Process</strong></p>

<ul>
<li>Uploads government ID photo</li>
<li>Takes selfie</li>
<li>ID.me verifies identity</li>
<li>Redirects back to backend</li>
</ul>

<p><strong>4. Backend Receives Verification</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/brrow/idme/callback&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Exchange code for access token</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.id.me/oauth/token&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">({</span>
<span class="w">      </span><span class="nx">client_id</span><span class="o">:</span><span class="w"> </span><span class="nx">IDME_CLIENT_ID</span><span class="p">,</span>
<span class="w">      </span><span class="nx">client_secret</span><span class="o">:</span><span class="w"> </span><span class="nx">IDME_CLIENT_SECRET</span><span class="p">,</span>
<span class="w">      </span><span class="nx">redirect_uri</span><span class="o">:</span><span class="w"> </span><span class="nx">IDME_REDIRECT_URI</span><span class="p">,</span>
<span class="w">      </span><span class="nx">grant_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;authorization_code&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">code</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">tokenResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Get user profile</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.id.me/api/public/v3/attributes.json&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">tokenData</span><span class="p">.</span><span class="nx">access_token</span><span class="si">}</span><span class="sb">`</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userProfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">userResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Store verification data</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">userProfile</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">is_verified</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">idme_uuid</span><span class="o">:</span><span class="w"> </span><span class="nx">userProfile</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span>
<span class="w">      </span><span class="nx">idme_verified_at</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Redirect to app</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;brrowapp://verification/success&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>5. iOS Handles Success</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// App receives deep link: brrowapp://verification/success</span>
<span class="kd">func</span><span class="w"> </span><span class="nf">scene</span><span class="p">(</span><span class="kc">_</span><span class="w"> </span><span class="n">scene</span><span class="p">:</span><span class="w"> </span><span class="bp">UIScene</span><span class="p">,</span><span class="w"> </span><span class="n">openURLContexts</span><span class="w"> </span><span class="n">URLContexts</span><span class="p">:</span><span class="w"> </span><span class="n">Set</span><span class="p">&lt;</span><span class="bp">UIOpenURLContext</span><span class="p">&gt;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">URLContexts</span><span class="p">.</span><span class="bp">first</span><span class="p">?.</span><span class="n">url</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">scheme</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;brrowapp&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">host</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;verification&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&quot;/success&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Show success message</span>
<span class="w">            </span><span class="c1">// Refresh user profile</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="verification-badge">Verification Badge</h3>

<p><strong>Display in UI</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="n">isVerified</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Image</span><span class="p">(</span><span class="n">systemName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;checkmark.seal.fill&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">blue</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h1 id="part-5-core-features-2">Part 5: Core Features</h1>

<h2 id="marketplace-system">Marketplace System</h2>

<h3 id="grid-layout">Grid Layout</h3>

<p><strong>ProfessionalMarketplaceView.swift</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">LazyVGrid</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="n">GridItem</span><span class="p">(.</span><span class="n">flexible</span><span class="p">(),</span><span class="w"> </span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">),</span>
<span class="w">    </span><span class="n">GridItem</span><span class="p">(.</span><span class="n">flexible</span><span class="p">(),</span><span class="w"> </span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span>
<span class="p">],</span><span class="w"> </span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ForEach</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">listings</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span><span class="n">ListingGridCard</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">onTapGesture</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// IMPORTANT: Use ID-based navigation to force view recreation</span>
<span class="w">                </span><span class="n">ListingNavigationManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">showListing</span><span class="p">(</span><span class="n">listing</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Important</strong>: The marketplace uses <code>.id(listing.listingId)</code> on the detail sheet to prevent SwiftUI from reusing the same view instance when different listings are tapped.</p>

<h3 id="infinite-scroll">Infinite Scroll</h3>

<div class="codehilite">
<pre><span></span><code><span class="n">ScrollView</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LazyVGrid</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ForEach</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">listings</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span><span class="n">ListingGridCard</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">onAppear</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Load more when last item appears</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">listings</span><span class="p">.</span><span class="bp">last</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">Task</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="k">await</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">loadNextPage</span><span class="p">()</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="category-filtering">Category Filtering</h3>

<div class="codehilite">
<pre><span></span><code><span class="n">ScrollView</span><span class="p">(.</span><span class="n">horizontal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HStack</span><span class="p">(</span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ForEach</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">categories</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span><span class="n">CategoryPill</span><span class="p">(</span>
<span class="w">                </span><span class="n">category</span><span class="p">:</span><span class="w"> </span><span class="n">category</span><span class="p">,</span>
<span class="w">                </span><span class="n">isSelected</span><span class="p">:</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">selectedCategory</span><span class="p">?.</span><span class="n">id</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="n">category</span><span class="p">.</span><span class="n">id</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">onTapGesture</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">viewModel</span><span class="p">.</span><span class="n">selectCategory</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2 id="messaging-system">Messaging System</h2>

<h3 id="real-time-chat-socketio">Real-Time Chat (Socket.IO)</h3>

<p><strong>Connection Setup</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">ChatViewModel</span><span class="p">:</span><span class="w"> </span><span class="n">ObservableObject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">socketManager</span><span class="p">:</span><span class="w"> </span><span class="n">SocketManager</span><span class="p">?</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">socket</span><span class="p">:</span><span class="w"> </span><span class="n">SocketIOClient</span><span class="p">?</span>

<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">connect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">AuthenticationService</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">authToken</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span>

<span class="w">        </span><span class="n">socketManager</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SocketManager</span><span class="p">(</span>
<span class="w">            </span><span class="n">socketURL</span><span class="p">:</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://brrow-backend-nodejs-production.up.railway.app&quot;</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
<span class="w">            </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
<span class="w">                </span><span class="p">.</span><span class="n">compress</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">extraHeaders</span><span class="p">([</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bearer </span><span class="si">\(</span><span class="n">token</span><span class="si">)</span><span class="s">&quot;</span><span class="p">])</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">socket</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">socketManager</span><span class="p">?.</span><span class="n">defaultSocket</span>

<span class="w">        </span><span class="c1">// Listen for events</span>
<span class="w">        </span><span class="n">socket</span><span class="p">?.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;connect&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="kr">weak</span><span class="w"> </span><span class="kc">self</span><span class="p">]</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span><span class="bp">print</span><span class="p">(</span><span class="s">&quot;âœ… Socket connected&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="kc">self</span><span class="p">?.</span><span class="n">joinConversation</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">socket</span><span class="p">?.</span><span class="n">on</span><span class="p">(</span><span class="s">&quot;new_message&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="kr">weak</span><span class="w"> </span><span class="kc">self</span><span class="p">]</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">messageData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="bp">first</span><span class="w"> </span><span class="k">as</span><span class="p">?</span><span class="w"> </span><span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="w"> </span><span class="nb">Any</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="p">?</span><span class="w"> </span><span class="n">Message</span><span class="p">(</span><span class="n">from</span><span class="p">:</span><span class="w"> </span><span class="n">messageData</span><span class="p">)</span>
<span class="w">            </span><span class="kc">self</span><span class="p">?.</span><span class="n">receiveMessage</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">socket</span><span class="p">?.</span><span class="n">connect</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">func</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="kc">_</span><span class="w"> </span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">socket</span><span class="p">?.</span><span class="n">emit</span><span class="p">(</span><span class="s">&quot;send_message&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s">&quot;conversation_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">conversationId</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">text</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;recipient_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">recipientId</span>
<span class="w">        </span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Backend WebSocket Handler</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// services/websocket.service.js</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>

<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">conversation_id</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">recipient_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Save to database</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">conversation_id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sender_id</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">recipient_id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Emit to recipient</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">recipient_id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">newMessage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sender</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Send push notification</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">sendPushNotification</span><span class="p">(</span><span class="nx">recipient_id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;New Message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="message-persistence">Message Persistence</h3>

<p><strong>Database Table</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">conversation_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">sender_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">recipient_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="w">  </span><span class="n">message</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">message_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="n">is_read</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">  </span><span class="n">read_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">  </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_conversation</span><span class="w"> </span><span class="p">(</span><span class="n">conversation_id</span><span class="p">),</span>
<span class="w">  </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_unread</span><span class="w"> </span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span><span class="w"> </span><span class="n">is_read</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>

<p><strong>Load Chat History</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/messages/chats/:conversationId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">conversationId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">conversation_id</span><span class="o">:</span><span class="w"> </span><span class="nx">conversationId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sender</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">          </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">          </span><span class="nx">profile_picture_url</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">skip</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">    </span><span class="nx">take</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="nx">messages</span><span class="p">.</span><span class="nx">reverse</span><span class="p">(),</span><span class="w"> </span><span class="c1">// Oldest first for chat UI</span>
<span class="w">    </span><span class="nx">pagination</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">page</span><span class="p">),</span>
<span class="w">      </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">limit</span><span class="p">),</span>
<span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
<span class="w">        </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">conversation_id</span><span class="o">:</span><span class="w"> </span><span class="nx">conversationId</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h2 id="listing-management-2">Listing Management</h2>

<h3 id="create-listing-flow">Create Listing Flow</h3>

<p><strong>1. User Fills Form</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="kd">struct</span><span class="w"> </span><span class="nc">ModernCreateListingView</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">title</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">price</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">selectedCategory</span><span class="p">:</span><span class="w"> </span><span class="n">Category</span><span class="p">?</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">selectedImages</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="bp">UIImage</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">@</span><span class="n">State</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">pricingType</span><span class="p">:</span><span class="w"> </span><span class="n">PricingType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">.</span><span class="n">sale</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">body</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Form</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TextField</span><span class="p">(</span><span class="s">&quot;Title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">title</span><span class="p">)</span>
<span class="w">            </span><span class="n">TextEditor</span><span class="p">(</span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">description</span><span class="p">)</span>
<span class="w">            </span><span class="n">TextField</span><span class="p">(</span><span class="s">&quot;Price&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">price</span><span class="p">)</span>

<span class="w">            </span><span class="n">Picker</span><span class="p">(</span><span class="s">&quot;Pricing Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">selection</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">pricingType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Sale&quot;</span><span class="p">).</span><span class="n">tag</span><span class="p">(</span><span class="n">PricingType</span><span class="p">.</span><span class="n">sale</span><span class="p">)</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Rent&quot;</span><span class="p">).</span><span class="n">tag</span><span class="p">(</span><span class="n">PricingType</span><span class="p">.</span><span class="n">rent</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">CategoryPicker</span><span class="p">(</span><span class="n">selection</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">selectedCategory</span><span class="p">)</span>

<span class="w">            </span><span class="n">ImagePicker</span><span class="p">(</span><span class="n">images</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">selectedImages</span><span class="p">)</span>

<span class="w">            </span><span class="n">Button</span><span class="p">(</span><span class="s">&quot;Create Listing&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Task</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">await</span><span class="w"> </span><span class="n">createListing</span><span class="p">()</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>2. Upload Images</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nf">createListing</span><span class="p">()</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Upload images first</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">imageURLs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nb">String</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">selectedImages</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">guard</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">imageData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">jpegData</span><span class="p">(</span><span class="n">compressionQuality</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nv">base64</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">imageData</span><span class="p">.</span><span class="n">base64EncodedString</span><span class="p">()</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">uploadImage</span><span class="p">(</span><span class="n">base64</span><span class="p">:</span><span class="w"> </span><span class="n">base64</span><span class="p">)</span>
<span class="w">        </span><span class="n">imageURLs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Create listing</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nv">listing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">APIClient</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">createListing</span><span class="p">(</span>
<span class="w">        </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">title</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="p">:</span><span class="w"> </span><span class="n">description</span><span class="p">,</span>
<span class="w">        </span><span class="n">price</span><span class="p">:</span><span class="w"> </span><span class="nb">Double</span><span class="p">(</span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="n">pricingType</span><span class="p">:</span><span class="w"> </span><span class="n">pricingType</span><span class="p">.</span><span class="n">rawValue</span><span class="p">,</span>
<span class="w">        </span><span class="n">categoryId</span><span class="p">:</span><span class="w"> </span><span class="n">selectedCategory</span><span class="p">?.</span><span class="n">id</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">images</span><span class="p">:</span><span class="w"> </span><span class="n">imageURLs</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Navigate to listing detail</span>
<span class="w">    </span><span class="n">ListingNavigationManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">showListing</span><span class="p">(</span><span class="n">listing</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>3. Backend Creates Listing</strong></p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/listings&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">title</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="p">,</span>
<span class="w">    </span><span class="nx">price</span><span class="p">,</span>
<span class="w">    </span><span class="nx">pricingType</span><span class="p">,</span>
<span class="w">    </span><span class="nx">categoryId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">images</span><span class="p">,</span>
<span class="w">    </span><span class="nx">location</span><span class="p">,</span>
<span class="w">    </span><span class="nx">condition</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tags</span><span class="p">,</span>
<span class="w">    </span><span class="nx">deliveryOptions</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create listing</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">listing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">title</span><span class="p">,</span>
<span class="w">      </span><span class="nx">description</span><span class="p">,</span>
<span class="w">      </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">price</span><span class="p">),</span>
<span class="w">      </span><span class="nx">daily_rate</span><span class="o">:</span><span class="w"> </span><span class="nx">pricingType</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rent&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">price</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">pricing_type</span><span class="o">:</span><span class="w"> </span><span class="nx">pricingType</span><span class="p">,</span>
<span class="w">      </span><span class="nx">category_id</span><span class="o">:</span><span class="w"> </span><span class="nx">categoryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">condition</span><span class="p">,</span>
<span class="w">      </span><span class="nx">location</span><span class="p">,</span>
<span class="w">      </span><span class="nx">tags</span><span class="p">,</span>
<span class="w">      </span><span class="nx">delivery_options</span><span class="o">:</span><span class="w"> </span><span class="nx">deliveryOptions</span><span class="p">,</span>
<span class="w">      </span><span class="nx">is_active</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">availability_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;AVAILABLE&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">moderation_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Create image records</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listing_images</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">listing_id</span><span class="o">:</span><span class="w"> </span><span class="nx">listing</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">image_url</span><span class="o">:</span><span class="w"> </span><span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
<span class="w">        </span><span class="nx">is_primary</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">display_order</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">listing</span><span class="o">:</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">      </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">listing</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">listing_images</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">users</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">categories</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h2 id="user-profiles">User Profiles</h2>

<h3 id="profile-view">Profile View</h3>

<p><strong>SimpleProfessionalProfileView.swift</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="kd">struct</span><span class="w"> </span><span class="nc">SimpleProfessionalProfileView</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">@</span><span class="n">StateObject</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">viewModel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ProfileViewModel</span><span class="p">()</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">body</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ScrollView</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">VStack</span><span class="p">(</span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Header</span>
<span class="w">                </span><span class="n">profileHeader</span>

<span class="w">                </span><span class="c1">// Stats</span>
<span class="w">                </span><span class="n">statsRow</span>

<span class="w">                </span><span class="c1">// Bio</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">bio</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">bio</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">font</span><span class="p">(.</span><span class="n">body</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Listings Grid</span>
<span class="w">                </span><span class="n">LazyVGrid</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="n">GridItem</span><span class="p">(.</span><span class="n">flexible</span><span class="p">()),</span>
<span class="w">                    </span><span class="n">GridItem</span><span class="p">(.</span><span class="n">flexible</span><span class="p">())</span>
<span class="w">                </span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ForEach</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">userListings</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="k">in</span>
<span class="w">                        </span><span class="n">ListingGridCard</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="n">task</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">loadProfile</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">profileHeader</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">VStack</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Profile picture</span>
<span class="w">            </span><span class="n">AsyncImage</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">profilePictureUrl</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">in</span>
<span class="w">                </span><span class="n">image</span>
<span class="w">                    </span><span class="p">.</span><span class="n">resizable</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">scaledToFill</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">placeholder</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Color</span><span class="p">.</span><span class="n">gray</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">clipShape</span><span class="p">(</span><span class="n">Circle</span><span class="p">())</span>

<span class="w">            </span><span class="c1">// Name and verification</span>
<span class="w">            </span><span class="n">HStack</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">displayName</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">username</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">font</span><span class="p">(.</span><span class="n">title2</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">bold</span><span class="p">()</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">isVerified</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Image</span><span class="p">(</span><span class="n">systemName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;checkmark.seal.fill&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">blue</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;@</span><span class="si">\(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">username</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">font</span><span class="p">(.</span><span class="n">subheadline</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">secondary</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">statsRow</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">HStack</span><span class="p">(</span><span class="n">spacing</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">StatView</span><span class="p">(</span>
<span class="w">                </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si">\(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">userListings</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Listings&quot;</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">StatView</span><span class="p">(</span>
<span class="w">                </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;%.1f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">averageRating</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">                </span><span class="n">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rating&quot;</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">StatView</span><span class="p">(</span>
<span class="w">                </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si">\(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">user</span><span class="p">?.</span><span class="n">totalRatings</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="mi">0</span><span class="si">)</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Reviews&quot;</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="edit-profile">Edit Profile</h3>

<p><strong>Important Fix</strong>: Display name vs username validation</p>

<p><strong>Backend</strong> (settings-system.js:107-140):</p>

<div class="codehilite">
<pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">username</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">username</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newUsername</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">username</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentUsername</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Only validate if username is actually different</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentUsername</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">newUsername</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">existingUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findFirst</span><span class="p">({</span>
<span class="w">      </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">newUsername</span><span class="p">,</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">not</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existingUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Username is already taken&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">updateData</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newUsername</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>This fix prevents</strong>:</p>

<ul>
<li>âŒ "Username is already taken" error when updating display name</li>
<li>âŒ False validation when username hasn't changed</li>
<li>âœ… Allows display name updates without username conflicts</li>
</ul>

<hr />

<h2 id="search-discovery">Search &amp; Discovery</h2>

<h3 id="search-endpoint">Search Endpoint</h3>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/listings/search&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="p">,</span><span class="w"> </span><span class="nx">minPrice</span><span class="p">,</span><span class="w"> </span><span class="nx">maxPrice</span><span class="p">,</span><span class="w"> </span><span class="nx">condition</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">is_active</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">OR</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Text search</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">where</span><span class="p">.</span><span class="nx">OR</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">contains</span><span class="o">:</span><span class="w"> </span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;insensitive&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">contains</span><span class="o">:</span><span class="w"> </span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;insensitive&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">has</span><span class="o">:</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Filters</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">category</span><span class="p">)</span><span class="w"> </span><span class="nx">where</span><span class="p">.</span><span class="nx">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">category</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">condition</span><span class="p">)</span><span class="w"> </span><span class="nx">where</span><span class="p">.</span><span class="nx">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">condition</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">minPrice</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">maxPrice</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">where</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">minPrice</span><span class="p">)</span><span class="w"> </span><span class="nx">where</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">gte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">minPrice</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">maxPrice</span><span class="p">)</span><span class="w"> </span><span class="nx">where</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">lte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">maxPrice</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">listings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="p">,</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">listing_images</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">users</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">profile_picture_url</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">categories</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">skip</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">    </span><span class="nx">take</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">limit</span><span class="p">),</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="nx">transformListingsForIOS</span><span class="p">(</span><span class="nx">listings</span><span class="p">),</span>
<span class="w">    </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="nx">q</span><span class="p">,</span>
<span class="w">    </span><span class="nx">pagination</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">page</span><span class="p">),</span>
<span class="w">      </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">limit</span><span class="p">),</span>
<span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h1 id="part-6-payment-systems-2">Part 6: Payment Systems</h1>

<h2 id="buy-now-direct-purchase">Buy Now (Direct Purchase)</h2>

<h3 id="complete-flow-documentation">Complete Flow Documentation</h3>

<p><strong>Already covered in Part 4 â†’ Stripe Payment System â†’ Buy Now Flow</strong></p>

<p>Key points:</p>

<ul>
<li>âœ… Creates purchase record (PENDING)</li>
<li>âœ… Creates Stripe checkout session</li>
<li>âœ… iOS opens checkout in SafariViewController</li>
<li>âœ… Webhook updates status to COMPLETED</li>
<li>âœ… Funds held for 7 days</li>
<li>âœ… Auto-release or manual verification</li>
</ul>

<hr />

<h2 id="seller-payouts">Seller Payouts</h2>

<h3 id="payment-hold-system">Payment Hold System</h3>

<p><strong>When purchase completes</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Purchase created with 7-day deadline</span>
<span class="nx">deadline</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>Automatic Release</strong> (after 7 days):</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Cron job runs daily</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expiredPurchases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">payment_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">verification_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">deadline</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">lte</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">seller</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">listing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">purchase</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">expiredPurchases</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Release payment to seller</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">releaseFundsToSeller</span><span class="p">(</span><span class="nx">purchase</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Daily</span>
</code></pre>
</div>

<p><strong>Manual Verification</strong> (buyer confirms):</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/purchases/:id/verify&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">purchase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Verify buyer owns this purchase</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">buyer_id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Not authorized&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Release funds</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">releaseFundsToSeller</span><span class="p">(</span><span class="nx">purchase</span><span class="p">);</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="release-to-seller">Release to Seller</h3>

<div class="codehilite">
<pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">releaseFundsToSeller</span><span class="p">(</span><span class="nx">purchase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">seller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">seller_id</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">seller</span><span class="p">.</span><span class="nx">stripe_account_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Seller has not set up Stripe Connect&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Calculate platform fee (10%)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">platformFee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.10</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sellerAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.90</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Transfer to seller</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transfer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">transfers</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">sellerAmount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">),</span><span class="w"> </span><span class="c1">// Convert to cents</span>
<span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="nx">seller</span><span class="p">.</span><span class="nx">stripe_account_id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">transfer_group</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">purchase_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">listing_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">listing_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">buyer_id</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Update purchase</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">verification_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;VERIFIED&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">verified_at</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Update listing</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">listings</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">listing_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">availability_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SOLD&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">is_active</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Send notification to seller</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">sendPushNotification</span><span class="p">(</span>
<span class="w">    </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">seller_id</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;Payment Released&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sb">`$</span><span class="si">${</span><span class="nx">sellerAmount</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb"> has been transferred to your account`</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />

<h2 id="transaction-history">Transaction History</h2>

<h3 id="endpoint">Endpoint</h3>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/purchases/my-purchases&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#39;buyer&#39;, &#39;seller&#39;, &#39;all&#39;</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;buyer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">where</span><span class="p">.</span><span class="nx">buyer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;seller&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">where</span><span class="p">.</span><span class="nx">seller_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">where</span><span class="p">.</span><span class="nx">OR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">seller_id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">purchases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="p">,</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">listing</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">listing_images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">is_primary</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">take</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">buyer</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">profile_picture_url</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">seller</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">profile_picture_url</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">purchases</span><span class="o">:</span><span class="w"> </span><span class="nx">purchases</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">amount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">paymentStatus</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">payment_status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">verificationStatus</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">verification_status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">purchaseType</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">purchase_type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">created_at</span><span class="p">,</span>
<span class="w">      </span><span class="nx">deadline</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">deadline</span><span class="p">,</span>
<span class="w">      </span><span class="nx">listing</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listing</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listing</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
<span class="w">        </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">listing</span><span class="p">.</span><span class="nx">listing_images</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">image_url</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">buyer</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">buyer</span><span class="p">,</span>
<span class="w">      </span><span class="nx">seller</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">seller</span><span class="p">,</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">buyer_id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;buyer&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;seller&#39;</span>
<span class="w">    </span><span class="p">}))</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h2 id="refunds-disputes">Refunds &amp; Disputes</h2>

<h3 id="refund-process">Refund Process</h3>

<p><strong>Buyer Requests Refund</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/purchases/:id/request-refund&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authenticateToken</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">purchase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">listing</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Verify buyer</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">buyer_id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Not authorized&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Check deadline hasn&#39;t passed</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">deadline</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Verification period has ended. Funds have been released.&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Create dispute</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dispute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">disputes</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">purchase_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">buyer_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">buyer_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">seller_id</span><span class="o">:</span><span class="w"> </span><span class="nx">purchase</span><span class="p">.</span><span class="nx">seller_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">reason</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PENDING&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Notify admin</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">logToDiscord</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;âš ï¸ Refund Request&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="sb">`Purchase </span><span class="si">${</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">listing</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amount&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`$</span><span class="si">${</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">amount</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">inline</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reason&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">reason</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="mh">0xFFA500</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dispute</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p><strong>Admin Reviews Dispute</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/admin/disputes/:id/resolve&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">adminAuth</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">resolution</span><span class="p">,</span><span class="w"> </span><span class="nx">refundAmount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dispute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">disputes</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">purchase</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">resolution</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;REFUND&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Issue refund via Stripe</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">refund</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">refunds</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">payment_intent</span><span class="o">:</span><span class="w"> </span><span class="nx">dispute</span><span class="p">.</span><span class="nx">purchase</span><span class="p">.</span><span class="nx">payment_intent_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">refundAmount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Update purchase</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">purchases</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">      </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">dispute</span><span class="p">.</span><span class="nx">purchase_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">payment_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;REFUNDED&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">verification_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DISPUTED&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Update dispute</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">disputes</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">dispute</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;RESOLVED&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">resolution</span><span class="p">,</span>
<span class="w">      </span><span class="nx">resolved_at</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">resolved_by</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">userId</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h1 id="part-7-deployment-infrastructure-2">Part 7: Deployment &amp; Infrastructure</h1>

<h2 id="railway-deployment">Railway Deployment</h2>

<h3 id="project-info">Project Info</h3>

<p><strong>Service</strong>: <code>brrow-backend-nodejs-production</code>
<strong>URL</strong>: https://brrow-backend-nodejs-production.up.railway.app
<strong>Region</strong>: <code>us-west1</code> (Oregon, USA)
<strong>Plan</strong>: Hobby ($5/month)</p>

<h3 id="deployment-process">Deployment Process</h3>

<p><strong>1. Auto-Deploy from GitHub</strong>:</p>

<pre><code>Local â†’ git push origin master â†’ GitHub â†’ Railway detects push â†’ Auto-deploys
</code></pre>

<p><strong>2. Build Process</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Railway runs these automatically:</span>
npm<span class="w"> </span>install
npx<span class="w"> </span>prisma<span class="w"> </span>generate
node<span class="w"> </span>prisma-server.js
</code></pre>
</div>

<p><strong>3. Health Check</strong>:</p>

<pre><code>Railway pings: /health
Expected: 200 OK
If fails: Restarts container
</code></pre>

<p><strong>4. Deployment Time</strong>:</p>

<ul>
<li>Build: ~1 minute</li>
<li>Deploy: ~30 seconds</li>
<li>Total: ~2 minutes</li>
</ul>

<h3 id="manual-deploy">Manual Deploy</h3>

<p><strong>Via Railway Dashboard</strong>:</p>

<ol>
<li>Go to https://railway.app</li>
<li>Select <code>brrow-backend-nodejs-production</code></li>
<li>Click "Deployments" tab</li>
<li>Click "â‹¯" on latest commit â†’ "Redeploy"</li>
</ol>

<p><strong>Via CLI</strong> (if Railway CLI installed):</p>

<div class="codehilite">
<pre><span></span><code>railway<span class="w"> </span>up
</code></pre>
</div>

<hr />

<h2 id="environment-variables">Environment Variables</h2>

<h3 id="complete-list-railway">Complete List (Railway)</h3>

<p><strong>Backend Server</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Database</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;postgresql://postgres:PASSWORD@host:port/railway&quot;</span>

<span class="c1"># JWT</span>
<span class="nv">JWT_SECRET</span><span class="o">=</span><span class="s2">&quot;your-secret-key-here&quot;</span>
<span class="nv">JWT_REFRESH_SECRET</span><span class="o">=</span><span class="s2">&quot;your-refresh-secret-here&quot;</span>

<span class="c1"># Stripe</span>
<span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_live_...&quot;</span><span class="w"> </span><span class="c1"># or sk_test_...</span>
<span class="nv">STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span><span class="s2">&quot;pk_live_...&quot;</span><span class="w"> </span><span class="c1"># or pk_test_...</span>
<span class="nv">STRIPE_WEBHOOK_SECRET</span><span class="o">=</span><span class="s2">&quot;whsec_...&quot;</span>

<span class="c1"># Cloudinary</span>
<span class="nv">CLOUDINARY_CLOUD_NAME</span><span class="o">=</span><span class="s2">&quot;brrow&quot;</span>
<span class="nv">CLOUDINARY_API_KEY</span><span class="o">=</span><span class="s2">&quot;918121214196197&quot;</span>
<span class="nv">CLOUDINARY_API_SECRET</span><span class="o">=</span><span class="s2">&quot;_uv_x8ku7vRhFN7Z0Ko61xibqYY&quot;</span>

<span class="c1"># Firebase</span>
<span class="nv">FIREBASE_PROJECT_ID</span><span class="o">=</span><span class="s2">&quot;brrow-app-firebase&quot;</span>
<span class="nv">FIREBASE_PRIVATE_KEY</span><span class="o">=</span><span class="s2">&quot;-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n&quot;</span>
<span class="nv">FIREBASE_CLIENT_EMAIL</span><span class="o">=</span><span class="s2">&quot;firebase-adminsdk-xxxxx@brrow-app-firebase.iam.gserviceaccount.com&quot;</span>

<span class="c1"># ID.me</span>
<span class="nv">IDME_CLIENT_ID</span><span class="o">=</span><span class="s2">&quot;02ef5aa6d4b40536a8cb82b7b902aba4&quot;</span>
<span class="nv">IDME_CLIENT_SECRET</span><span class="o">=</span><span class="s2">&quot;d79736fd19dd7960b40d4a342fd56876&quot;</span>
<span class="nv">IDME_REDIRECT_URI</span><span class="o">=</span><span class="s2">&quot;https://brrow-backend-nodejs-production.up.railway.app/brrow/idme/callback&quot;</span>

<span class="c1"># Google OAuth</span>
<span class="nv">GOOGLE_CLIENT_ID</span><span class="o">=</span><span class="s2">&quot;your-google-client-id&quot;</span>
<span class="nv">GOOGLE_CLIENT_SECRET</span><span class="o">=</span><span class="s2">&quot;your-google-client-secret&quot;</span>

<span class="c1"># Discord (for error logging)</span>
<span class="nv">DISCORD_WEBHOOK_URL</span><span class="o">=</span><span class="s2">&quot;https://discord.com/api/webhooks/...&quot;</span>

<span class="c1"># Server Config</span>
<span class="nv">NODE_ENV</span><span class="o">=</span><span class="s2">&quot;production&quot;</span>
<span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;3001&quot;</span>
</code></pre>
</div>

<h3 id="how-to-update">How to Update</h3>

<p><strong>Railway Dashboard</strong>:</p>

<ol>
<li>Go to service</li>
<li>Click "Variables" tab</li>
<li>Click variable to edit OR "New Variable"</li>
<li>Enter value</li>
<li>Click outside to save</li>
<li>Service auto-restarts</li>
</ol>

<p><strong>âš ï¸ Important</strong>:</p>

<ul>
<li>Railway encrypts secrets automatically</li>
<li>Variables are available as <code>process.env.VARIABLE_NAME</code></li>
<li>Restart required for changes to take effect</li>
<li>Test mode Stripe keys: Change <code>STRIPE_SECRET_KEY</code> and <code>STRIPE_PUBLISHABLE_KEY</code> to <code>sk_test_...</code> and <code>pk_test_...</code></li>
</ul>

<hr />

<h2 id="database-management">Database Management</h2>

<h3 id="access-database">Access Database</h3>

<p><strong>Via Railway CLI</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Install Railway CLI</span>
npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>railway

<span class="c1"># Login</span>
railway<span class="w"> </span>login

<span class="c1"># Link project</span>
railway<span class="w"> </span>link

<span class="c1"># Connect to PostgreSQL</span>
railway<span class="w"> </span>run<span class="w"> </span>psql<span class="w"> </span><span class="nv">$DATABASE_URL</span>
</code></pre>
</div>

<p><strong>Via pgAdmin / TablePlus</strong>:</p>

<pre><code>Host: yamanote.proxy.rlwy.net
Port: 10740
Database: railway
Username: postgres
Password: kciFfaaVBLcfEAlHomvyNFnbMjIxGdOE
</code></pre>

<h3 id="prisma-migrations">Prisma Migrations</h3>

<p><strong>Local Development</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>brrow-backend

<span class="c1"># Create migration</span>
npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>dev<span class="w"> </span>--name<span class="w"> </span>add_new_field

<span class="c1"># Push to database (skip migration)</span>
npx<span class="w"> </span>prisma<span class="w"> </span>db<span class="w"> </span>push

<span class="c1"># Generate Prisma Client</span>
npx<span class="w"> </span>prisma<span class="w"> </span>generate
</code></pre>
</div>

<p><strong>Production</strong> (Railway auto-runs):</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># On deploy, Railway runs:</span>
npx<span class="w"> </span>prisma<span class="w"> </span>generate

<span class="c1"># Manual migration:</span>
railway<span class="w"> </span>run<span class="w"> </span>npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>deploy
</code></pre>
</div>

<h3 id="common-queries">Common Queries</h3>

<p><strong>Check table structure</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">users</span>
<span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">listings</span>
<span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">purchases</span>
</code></pre>
</div>

<p><strong>Count records</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">listings</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">purchases</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">payment_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">;</span>
</code></pre>
</div>

<p><strong>View recent purchases</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">SELECT</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span>
<span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">payment_status</span><span class="p">,</span>
<span class="w">  </span><span class="n">l</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">listing_title</span><span class="p">,</span>
<span class="w">  </span><span class="n">b</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">buyer</span><span class="p">,</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">seller</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">purchases</span><span class="w"> </span><span class="n">p</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">listings</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">listing_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">buyer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">seller_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre>
</div>

<hr />

<h2 id="monitoring-logging">Monitoring &amp; Logging</h2>

<h3 id="railway-logs">Railway Logs</h3>

<p><strong>View Logs</strong>:</p>

<ol>
<li>Railway Dashboard</li>
<li>Select service</li>
<li>Click "Deployments" tab</li>
<li>Click on deployment</li>
<li>See real-time logs</li>
</ol>

<p><strong>Log Levels</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Server started&#39;</span><span class="p">);</span><span class="w">    </span><span class="c1">// âœ… Info</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Slow query&#39;</span><span class="p">);</span><span class="w">        </span><span class="c1">// âš ï¸ Warning</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Database failed&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// âŒ Error</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Request details&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// ğŸ” Debug (production: disabled)</span>
</code></pre>
</div>

<h3 id="health-monitoring">Health Monitoring</h3>

<p><strong>Health Endpoint</strong> (<code>/health</code>):</p>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;brrow-backend&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.3.4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;database&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;connected&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;uptime&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12345.67</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;rss&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">197685248</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;heapTotal&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">45010944</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;heapUsed&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">41878464</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Railway checks</strong>:</p>

<ul>
<li>Every 30 seconds</li>
<li>If 503 â†’ Restarts container</li>
<li>If 200 â†’ Healthy</li>
</ul>

<h3 id="discord-alerts">Discord Alerts</h3>

<p><strong>Error notifications sent to Discord</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nx">logToDiscord</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;Payment Failed&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;User&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">inline</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Amount&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`$</span><span class="si">${</span><span class="nx">amount</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">inline</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="mh">0xFF0000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Red color</span>
<span class="w">  </span><span class="kc">true</span><span class="w">      </span><span class="c1">// isError</span>
<span class="p">);</span>
</code></pre>
</div>

<h3 id="memory-monitoring">Memory Monitoring</h3>

<p><strong>Auto-monitoring</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Logs every minute</span>
<span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">logMemoryUsage</span><span class="p">(),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>

<span class="c1">// Alerts if &gt; 400MB</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">memoryMonitor</span><span class="p">(</span><span class="mf">400</span><span class="p">));</span>

<span class="c1">// Garbage collection</span>
<span class="nx">scheduleGarbageCollection</span><span class="p">();</span>
</code></pre>
</div>

<hr />

<h1 id="part-8-development-guides-2">Part 8: Development Guides</h1>

<h2 id="local-development-setup">Local Development Setup</h2>

<h3 id="prerequisites">Prerequisites</h3>

<p><strong>Required Software</strong>:</p>

<ul>
<li>Node.js 18+</li>
<li>PostgreSQL 15+</li>
<li>Git</li>
<li>Xcode 15+ (for iOS)</li>
<li>CocoaPods</li>
</ul>

<h3 id="backend-setup">Backend Setup</h3>

<p><strong>1. Clone Repository</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Documents/Projects
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/shalinratna/brrow-backend-nodejs.git
<span class="nb">cd</span><span class="w"> </span>brrow-backend-nodejs
</code></pre>
</div>

<p><strong>2. Install Dependencies</strong>:</p>

<div class="codehilite">
<pre><span></span><code>npm<span class="w"> </span>install
</code></pre>
</div>

<p><strong>3. Setup Environment</strong>:</p>

<div class="codehilite">
<pre><span></span><code>cp<span class="w"> </span>.env.example<span class="w"> </span>.env
<span class="c1"># Edit .env with your credentials</span>
</code></pre>
</div>

<p><strong>4. Setup Database</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Start PostgreSQL (if local)</span>
pg_ctl<span class="w"> </span>start

<span class="c1"># Create database</span>
createdb<span class="w"> </span>brrow_dev

<span class="c1"># Update DATABASE_URL in .env</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;postgresql://localhost:5432/brrow_dev&quot;</span>

<span class="c1"># Run migrations</span>
npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>dev

<span class="c1"># Generate Prisma Client</span>
npx<span class="w"> </span>prisma<span class="w"> </span>generate
</code></pre>
</div>

<p><strong>5. Start Server</strong>:</p>

<div class="codehilite">
<pre><span></span><code>node<span class="w"> </span>prisma-server.js
<span class="c1"># Server runs on http://localhost:3001</span>
</code></pre>
</div>

<p><strong>6. Test</strong>:</p>

<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>http://localhost:3001/health
<span class="c1"># Should return: {&quot;status&quot;:&quot;healthy&quot;,...}</span>
</code></pre>
</div>

<h3 id="ios-setup">iOS Setup</h3>

<p><strong>1. Install CocoaPods</strong>:</p>

<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>gem<span class="w"> </span>install<span class="w"> </span>cocoapods
</code></pre>
</div>

<p><strong>2. Install Pods</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Documents/Projects/Xcode/Brrow
pod<span class="w"> </span>install
</code></pre>
</div>

<p><strong>3. Open Workspace</strong>:</p>

<div class="codehilite">
<pre><span></span><code>open<span class="w"> </span>Brrow.xcworkspace
</code></pre>
</div>

<p><strong>4. Configure Signing</strong>:</p>

<ul>
<li>Xcode â†’ Brrow target â†’ Signing &amp; Capabilities</li>
<li>Select your Apple Developer account</li>
<li>Choose development team</li>
</ul>

<p><strong>5. Run on Simulator</strong>:</p>

<ul>
<li>Select iPhone 16 Pro simulator</li>
<li>Click Run (âŒ˜R)</li>
</ul>

<hr />

<h2 id="testing-strategies">Testing Strategies</h2>

<h3 id="manual-testing-checklist">Manual Testing Checklist</h3>

<p><strong>Authentication</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Register new user</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Login with email</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Login with Google</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Login with Apple</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Logout</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Token refresh</li>
</ul>

<p><strong>Listings</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Browse marketplace</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Filter by category</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Search listings</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> View listing detail</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Create listing (sale)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Create listing (rent)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Edit listing</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Delete listing</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Upload images</li>
</ul>

<p><strong>Messaging</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Send message</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Receive message (real-time)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Load chat history</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Mark as read</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Unread count badge</li>
</ul>

<p><strong>Payments</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Buy Now flow</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Stripe checkout</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Payment success</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Payment cancel</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> View transaction history</li>
</ul>

<p><strong>Profile</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> View own profile</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Edit profile</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Change display name</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Upload profile picture</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> View other user profile</li>
</ul>

<h3 id="test-accounts">Test Accounts</h3>

<p><strong>Backend (Local)</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Create test user via API</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:3001/api/auth/register<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;email&quot;: &quot;test@example.com&quot;,</span>
<span class="s1">    &quot;password&quot;: &quot;TestPass123&quot;,</span>
<span class="s1">    &quot;username&quot;: &quot;testuser&quot;,</span>
<span class="s1">    &quot;firstName&quot;: &quot;Test&quot;,</span>
<span class="s1">    &quot;lastName&quot;: &quot;User&quot;</span>
<span class="s1">  }&#39;</span>
</code></pre>
</div>

<p><strong>Stripe Test Mode</strong>:</p>

<ul>
<li>Card: 4242 4242 4242 4242</li>
<li>Expiry: Any future date</li>
<li>CVC: Any 3 digits</li>
<li>ZIP: Any 5 digits</li>
</ul>

<hr />

<h2 id="debugging-tools">Debugging Tools</h2>

<h3 id="ios-debugging">iOS Debugging</h3>

<p><strong>Console Logging</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Custom emoji logging</span>
<span class="bp">print</span><span class="p">(</span><span class="s">&quot;ğŸ”µ [DEBUG] Variable value: </span><span class="si">\(</span><span class="n">value</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="bp">print</span><span class="p">(</span><span class="s">&quot;âœ… [SUCCESS] Operation completed&quot;</span><span class="p">)</span>
<span class="bp">print</span><span class="p">(</span><span class="s">&quot;âŒ [ERROR] Failed: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p><strong>Network Debugging</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// APIClient logs all requests</span>
<span class="err">ğŸ›</span><span class="w"> </span><span class="p">[</span><span class="n">Brrow</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Debug</span><span class="p">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">request</span>
<span class="err">ğŸ“Š</span><span class="w"> </span><span class="n">Data</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;endpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;api/listings&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="p">]</span>
<span class="err">ğŸ“¡</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">listings</span>
</code></pre>
</div>

<p><strong>Breakpoints</strong>:</p>

<ul>
<li>Set breakpoint in Xcode (click line number)</li>
<li>Click "Add Exception Breakpoint" for crashes</li>
<li>Use <code>po variable</code> in console to inspect</li>
</ul>

<p><strong>Memory Leaks</strong>:</p>

<ul>
<li>Xcode â†’ Product â†’ Profile</li>
<li>Select "Leaks" instrument</li>
<li>Run app and look for red bars</li>
</ul>

<h3 id="backend-debugging">Backend Debugging</h3>

<p><strong>Pino Logging</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">({</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;123&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;User logged in&#39;</span><span class="p">);</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">({</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SELECT...&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;Slow query&#39;</span><span class="p">);</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;Database failed&#39;</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>Railway Logs</strong>:</p>

<ul>
<li>Real-time logs in Railway dashboard</li>
<li>Filter by level (info, warn, error)</li>
<li>Search by keyword</li>
</ul>

<p><strong>Database Queries</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Log all Prisma queries (add to .env)</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="s2">&quot;prisma:query&quot;</span>

<span class="c1"># Restart server, see all SQL queries in console</span>
</code></pre>
</div>

<hr />

<h2 id="common-issues-fixes">Common Issues &amp; Fixes</h2>

<h3 id="issue-username-is-already-taken-when-updating-display-name">Issue: "Username is already taken" when updating display name</h3>

<p><strong>Symptom</strong>: Error when changing display name, even though username isn't changing.</p>

<p><strong>Fix</strong>: Already deployed to Railway (2025-10-08)</p>

<p><strong>Verification</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Check Railway logs for:</span>
âœ…<span class="w"> </span>Username<span class="w"> </span>unchanged,<span class="w"> </span>skipping<span class="w"> </span>validation
</code></pre>
</div>

<h3 id="issue-wrong-listing-shows-when-tapped">Issue: Wrong listing shows when tapped</h3>

<p><strong>Symptom</strong>: Tap listing A, but listing B appears.</p>

<p><strong>Fix</strong>: Already implemented (ListingNavigationManager.swift:107, 114)</p>

<p><strong>Code</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="p">.</span><span class="n">sheet</span><span class="p">(</span><span class="n">isPresented</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">navigationManager</span><span class="p">.</span><span class="n">showingListingDetail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nv">listing</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">navigationManager</span><span class="p">.</span><span class="n">selectedListing</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">NavigationView</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ProfessionalListingDetailView</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span><span class="w"> </span><span class="n">listing</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">.</span><span class="n">id</span><span class="p">(</span><span class="n">listing</span><span class="p">.</span><span class="n">listingId</span><span class="p">)</span><span class="w"> </span><span class="c1">// â† Forces view recreation</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="issue-archive-shows-as-generic-xcode-archive">Issue: Archive shows as "Generic Xcode Archive"</h3>

<p><strong>Symptom</strong>: Xcode Organizer shows archive as Generic instead of iOS App.</p>

<p><strong>Solution</strong>: Post-action script adds ApplicationProperties.</p>

<p><strong>Verification</strong>:</p>

<div class="codehilite">
<pre><span></span><code>defaults<span class="w"> </span><span class="nb">read</span><span class="w"> </span>~/Library/Developer/Xcode/Archives/*/Brrow*.xcarchive/Info.plist<span class="w"> </span>ApplicationProperties
<span class="c1"># Should show CFBundleIdentifier, CFBundleVersion, etc.</span>
</code></pre>
</div>

<p><strong>If still broken</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Clear Xcode cache</span>
rm<span class="w"> </span>~/Library/Developer/Xcode/UserData/IDEArchiveDatabase.db*
</code></pre>
</div>

<h3 id="issue-backend-returning-500-errors">Issue: Backend returning 500 errors</h3>

<p><strong>Symptoms</strong>:</p>

<pre><code>ğŸ“¡ Response: 500 for /api/listings
ğŸ“¡ Response: 500 for /api/users/me
</code></pre>

<p><strong>Diagnosis</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Check Railway logs for:</span>
Engine<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>yet<span class="w"> </span>connected
PrismaClientUnknownRequestError
</code></pre>
</div>

<p><strong>Fix</strong>: Already deployed (2025-10-08)</p>

<p><strong>Code</strong> (prisma-server.js:9899):</p>

<div class="codehilite">
<pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">startServer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Explicitly connect to database</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">$connect</span><span class="p">();</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Database connected successfully&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Start server</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">httpServer</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="issue-images-not-loading-in-ios-app">Issue: Images not loading in iOS app</h3>

<p><strong>Symptoms</strong>:</p>

<ul>
<li>Gray placeholders</li>
<li><code>BrrowAsyncImage: Empty/null URL input</code></li>
</ul>

<p><strong>Diagnosis</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// Check logs for:</span>
<span class="err">ğŸ–¼ï¸</span><span class="w"> </span><span class="n">BrrowAsyncImage</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">null</span><span class="err">&#39;</span>
</code></pre>
</div>

<p><strong>Fix</strong>: Verify Cloudinary URLs in database</p>

<p><strong>Query</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">,</span>
<span class="w">  </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">listing_images</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">listing_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listings</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">image_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">listings</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;your-listing-id&#39;</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">image_url</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">listing_images</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">listing_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;your-listing-id&#39;</span><span class="p">;</span>
</code></pre>
</div>

<hr />

<h1 id="part-9-xcode-ios-build-2">Part 9: Xcode &amp; iOS Build</h1>

<h2 id="xcode-project-structure">Xcode Project Structure</h2>

<h3 id="workspace-vs-project">Workspace vs Project</h3>

<p><strong>Brrow.xcworkspace</strong> (use this):</p>

<ul>
<li>Includes Brrow.xcodeproj</li>
<li>Includes Pods project (34 dependencies)</li>
<li>Required for CocoaPods</li>
</ul>

<p><strong>Brrow.xcodeproj</strong> (don't use directly):</p>

<ul>
<li>Main app project</li>
<li>Won't build without workspace (missing Pods)</li>
</ul>

<h3 id="targets">Targets</h3>

<p><strong>1. Brrow</strong> (Main App):</p>

<ul>
<li>Bundle ID: <code>com.shaiitech.com.brrow</code></li>
<li>Platform: iOS 16+</li>
<li>Architectures: arm64 (iPhone)</li>
<li>Build: 594</li>
<li>Version: 1.3.4</li>
</ul>

<p><strong>2. BrrowWidgets</strong> (Widget Extension):</p>

<ul>
<li>Bundle ID: <code>com.shaiitech.com.brrow.BrrowWidgets</code></li>
<li>Platform: iOS 16+</li>
<li>Embedded in main app</li>
</ul>

<p><strong>3. BrrowTests</strong> (Unit Tests):</p>

<ul>
<li>Test bundle</li>
</ul>

<p><strong>4. BrrowUITests</strong> (UI Tests):</p>

<ul>
<li>UI test bundle</li>
</ul>

<h3 id="build-settings-important">Build Settings (Important)</h3>

<p><strong>Release Configuration</strong> (Brrow target):</p>

<pre><code>ARCHS = arm64
CODE_SIGN_STYLE = Automatic
DEVELOPMENT_TEAM = UXM5W873X3
PRODUCT_BUNDLE_IDENTIFIER = com.shaiitech.com.brrow
CURRENT_PROJECT_VERSION = 594
MARKETING_VERSION = 1.3.4
SKIP_INSTALL = NO
DEPLOYMENT_LOCATION = NO
INFOPLIST_KEY_CFBundleDisplayName = Brrow
</code></pre>

<hr />

<h2 id="archive-distribution">Archive &amp; Distribution</h2>

<h3 id="why-post-action-script-is-necessary">Why Post-Action Script is Necessary</h3>

<p><strong>The Problem</strong>:</p>

<ul>
<li>Xcode's auto-archiving fails with CocoaPods + App Extensions</li>
<li>Archive's <code>Info.plist</code> missing <code>ApplicationProperties</code> dictionary</li>
<li>Organizer shows "Generic Xcode Archive" instead of "iOS App"</li>
<li>Cannot distribute to App Store</li>
</ul>

<p><strong>The Solution</strong>:</p>

<ul>
<li>Post-action script runs after archive completes</li>
<li>Adds <code>ApplicationProperties</code> to archive's <code>Info.plist</code></li>
<li>Archive now recognized as iOS App</li>
<li>Can export IPA and upload to App Store</li>
</ul>

<p><strong>Post-Action Location</strong>:
<code>Brrow.xcworkspace/xcshareddata/xcschemes/Brrow.xcscheme</code></p>

<p><strong>XML</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nt">&lt;ArchiveAction</span><span class="w"> </span><span class="na">buildConfiguration=</span><span class="s">&quot;Release&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;PostActions&gt;</span>
<span class="w">    </span><span class="nt">&lt;ExecutionAction</span><span class="w"> </span><span class="na">ActionType=</span><span class="s">&quot;ShellScriptAction&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;ActionContent</span><span class="w"> </span><span class="na">title=</span><span class="s">&quot;Add ApplicationProperties&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>#!/bin/bash
<span class="w">        </span>${SRCROOT}/fix-archive-proper.sh
<span class="w">      </span><span class="nt">&lt;/ActionContent&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ExecutionAction&gt;</span>
<span class="w">  </span><span class="nt">&lt;/PostActions&gt;</span>
<span class="nt">&lt;/ArchiveAction&gt;</span>
</code></pre>
</div>

<p><strong>Script</strong> (<code>fix-archive-proper.sh</code>):</p>

<div class="codehilite">
<pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">ARCHIVE_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCHIVE_PATH</span><span class="s2">&quot;</span>
<span class="nv">INFO_PLIST</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCHIVE_PATH</span><span class="s2">/Info.plist&quot;</span>

<span class="c1"># Add ApplicationProperties if missing</span>
/usr/libexec/PlistBuddy<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Add :ApplicationProperties dict&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INFO_PLIST</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
/usr/libexec/PlistBuddy<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Add :ApplicationProperties:ApplicationPath string &#39;Applications/Brrow.app&#39;&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INFO_PLIST</span><span class="s2">&quot;</span>
/usr/libexec/PlistBuddy<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Add :ApplicationProperties:CFBundleIdentifier string &#39;com.shaiitech.com.brrow&#39;&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INFO_PLIST</span><span class="s2">&quot;</span>
/usr/libexec/PlistBuddy<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Add :ApplicationProperties:CFBundleShortVersionString string &#39;1.3.4&#39;&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INFO_PLIST</span><span class="s2">&quot;</span>
/usr/libexec/PlistBuddy<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Add :ApplicationProperties:CFBundleVersion string &#39;594&#39;&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$INFO_PLIST</span><span class="s2">&quot;</span>
</code></pre>
</div>

<h3 id="archive-process">Archive Process</h3>

<p><strong>1. Clean Build</strong> (recommended):</p>

<pre><code>Xcode â†’ Product â†’ Clean Build Folder (âŒ˜â‡§K)
</code></pre>

<p><strong>2. Archive</strong>:</p>

<pre><code>Xcode â†’ Product â†’ Archive (âŒ˜â‡§B for build, then Archive)
</code></pre>

<p><strong>3. Wait</strong>:</p>

<ul>
<li>Build time: ~2-3 minutes</li>
<li>Archive creation: ~10 seconds</li>
<li>Post-action script: &lt;1 second</li>
<li>Total: ~3 minutes</li>
</ul>

<p><strong>4. Verify</strong>:</p>

<pre><code>Window â†’ Organizer â†’ Archives
Should show: "Brrow" as "iOS App"
Build number: 594
</code></pre>

<h3 id="export-ipa">Export IPA</h3>

<p><strong>1. Select Archive</strong>:</p>

<ul>
<li>Window â†’ Organizer â†’ Archives</li>
<li>Select latest archive</li>
<li>Click "Distribute App"</li>
</ul>

<p><strong>2. Distribution Method</strong>:</p>

<ul>
<li><strong>App Store Connect</strong>: Upload to TestFlight/App Store</li>
<li><strong>Ad Hoc</strong>: Install on registered devices</li>
<li><strong>Enterprise</strong>: Company distribution</li>
<li><strong>Development</strong>: Testing on devices</li>
</ul>

<p><strong>3. Options</strong>:</p>

<ul>
<li>âœ… Upload your app's symbols (for crash reports)</li>
<li>âœ… Include bitcode (if required)</li>
<li>âœ… Manage Version and Build Number</li>
</ul>

<p><strong>4. Signing</strong>:</p>

<ul>
<li>Automatic signing (recommended)</li>
<li>Or: Manual signing with provisioning profile</li>
</ul>

<p><strong>5. Export</strong>:</p>

<ul>
<li>Click "Export"</li>
<li>Choose location</li>
<li>Xcode creates <code>.ipa</code> file</li>
</ul>

<h3 id="upload-to-app-store">Upload to App Store</h3>

<p><strong>Via Xcode</strong>:</p>

<ol>
<li>Archive â†’ Distribute App</li>
<li>Select "App Store Connect"</li>
<li>Select "Upload"</li>
<li>Wait for processing (~5 minutes)</li>
<li>Check App Store Connect</li>
</ol>

<p><strong>Via Transporter</strong> (alternative):</p>

<ol>
<li>Export IPA (Distribution method: "App Store Connect")</li>
<li>Open Transporter app</li>
<li>Drag IPA file</li>
<li>Click "Deliver"</li>
</ol>

<p><strong>Verification</strong>:</p>

<ol>
<li>Go to https://appstoreconnect.apple.com</li>
<li>My Apps â†’ Brrow</li>
<li>TestFlight tab</li>
<li>See build appear (~5-15 minutes)</li>
<li>Status: "Processing" â†’ "Testing"</li>
</ol>

<hr />

<h2 id="cocoapods-dependencies">CocoaPods Dependencies</h2>

<h3 id="current-pods-34-total">Current Pods (34 total)</h3>

<p><strong>Networking</strong>:</p>

<ul>
<li>Alamofire (HTTP)</li>
<li>Socket.IO-Client-Swift (WebSocket)</li>
</ul>

<p><strong>Images</strong>:</p>

<ul>
<li>SDWebImage (Async loading &amp; caching)</li>
<li>SDWebImageSwiftUI (SwiftUI integration)</li>
</ul>

<p><strong>Payments</strong>:</p>

<ul>
<li>StripePaymentSheet</li>
<li>StripePayments</li>
<li>StripePaymentsUI</li>
<li>StripeUICore</li>
<li>StripeCore</li>
<li>StripeApplePay</li>
</ul>

<p><strong>Firebase</strong> (13 pods):</p>

<ul>
<li>Firebase</li>
<li>FirebaseAnalytics</li>
<li>FirebaseAuth</li>
<li>FirebaseCore</li>
<li>FirebaseCoreInternal</li>
<li>FirebaseMessaging</li>
<li>FirebaseInstallations</li>
<li>GoogleDataTransport</li>
<li>GoogleUtilities</li>
<li>nanopb</li>
<li>PromisesObjC</li>
</ul>

<p><strong>Social Login</strong>:</p>

<ul>
<li>GoogleSignIn</li>
<li>FBSDKLoginKit (Facebook)</li>
</ul>

<p><strong>UI</strong>:</p>

<ul>
<li>SwiftyGif (GIF support)</li>
<li>Starscream (WebSocket)</li>
</ul>

<h3 id="managing-pods">Managing Pods</h3>

<p><strong>Update Pods</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Documents/Projects/Xcode/Brrow
pod<span class="w"> </span>update
</code></pre>
</div>

<p><strong>Install New Pod</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Edit Podfile</span>
<span class="n">pod</span><span class="w"> </span><span class="s1">&#39;NewPodName&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~&gt; 1.0&#39;</span>

<span class="c1"># Install</span>
<span class="n">pod</span><span class="w"> </span><span class="n">install</span>
</code></pre>
</div>

<p><strong>Remove Pod</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Remove from Podfile</span>
<span class="c1"># Then:</span>
<span class="n">pod</span><span class="w"> </span><span class="n">install</span>
</code></pre>
</div>

<p><strong>Clean</strong>:</p>

<div class="codehilite">
<pre><span></span><code>pod<span class="w"> </span>deintegrate
pod<span class="w"> </span>install
</code></pre>
</div>

<hr />

<h2 id="app-store-submission">App Store Submission</h2>

<h3 id="pre-submission-checklist">Pre-Submission Checklist</h3>

<p><strong>Code</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> No test/debug code in release</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> No hardcoded credentials</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> All API keys in environment</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Error handling on all network calls</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Proper loading states</li>
</ul>

<p><strong>Assets</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> App icon (all sizes)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Launch screen</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Screenshots (all required sizes)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Preview video (optional)</li>
</ul>

<p><strong>Metadata</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> App name</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Subtitle</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Description</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Keywords</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Support URL</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Privacy policy URL</li>
</ul>

<p><strong>Compliance</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Privacy nutrition label</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Export compliance (encryption)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Content rights</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Age rating</li>
</ul>

<h3 id="app-store-connect-setup">App Store Connect Setup</h3>

<p><strong>1. Create App</strong>:</p>

<ul>
<li>Go to https://appstoreconnect.apple.com</li>
<li>My Apps â†’ "+" â†’ New App</li>
<li>Platform: iOS</li>
<li>Name: Brrow</li>
<li>Primary Language: English (U.S.)</li>
<li>Bundle ID: com.shaiitech.com.brrow</li>
<li>SKU: brrow-ios-app</li>
</ul>

<p><strong>2. App Information</strong>:</p>

<ul>
<li>Category: Lifestyle / Shopping</li>
<li>Content Rights: Check box</li>
<li>Age Rating: Fill questionnaire</li>
</ul>

<p><strong>3. Pricing</strong>:</p>

<ul>
<li>Free</li>
<li>Available in all territories</li>
</ul>

<p><strong>4. Build</strong>:</p>

<ul>
<li>Upload via Xcode or Transporter</li>
<li>Select build in App Store Connect</li>
<li>Add export compliance info</li>
</ul>

<p><strong>5. Submit for Review</strong>:</p>

<ul>
<li>Fill all required fields</li>
<li>Add screenshots</li>
<li>Click "Submit for Review"</li>
<li>Wait for Apple review (~24-48 hours)</li>
</ul>

<hr />

<h1 id="part-10-maintenance-updates-2">Part 10: Maintenance &amp; Updates</h1>

<h2 id="version-management">Version Management</h2>

<h3 id="versioning-strategy">Versioning Strategy</h3>

<p><strong>Semantic Versioning</strong> (MAJOR.MINOR.PATCH):</p>

<pre><code>1.3.4
â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€ Patch (bug fixes)
â”‚ â””â”€â”€â”€ Minor (new features, backward compatible)
â””â”€â”€â”€â”€â”€ Major (breaking changes)
</code></pre>

<p><strong>Examples</strong>:</p>

<ul>
<li><code>1.3.4</code> â†’ <code>1.3.5</code>: Bug fix</li>
<li><code>1.3.5</code> â†’ <code>1.4.0</code>: New feature (e.g., video calls)</li>
<li><code>1.4.0</code> â†’ <code>2.0.0</code>: Major redesign</li>
</ul>

<h3 id="incrementing-version">Incrementing Version</h3>

<p><strong>iOS</strong> (Xcode):</p>

<pre><code>1. Brrow target â†’ General
2. Version: 1.3.4 â†’ 1.3.5 (MARKETING_VERSION)
3. Build: 594 â†’ 595 (CURRENT_PROJECT_VERSION)
4. Archive with new build number
</code></pre>

<p><strong>Backend</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1">// prisma-server.js:2</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">VERSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1.3.5&#39;</span><span class="p">;</span>

<span class="c1">// Also update package.json:</span>
<span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.3.5&quot;</span>
</code></pre>
</div>

<p><strong>Sync Required</strong>:
âœ… iOS and backend versions should match for clarity</p>

<hr />

<h2 id="update-procedures">Update Procedures</h2>

<h3 id="backend-update-railway">Backend Update (Railway)</h3>

<p><strong>1. Make Changes</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Documents/Projects/Xcode/Brrow/brrow-backend
<span class="c1"># Edit files</span>
</code></pre>
</div>

<p><strong>2. Test Locally</strong>:</p>

<div class="codehilite">
<pre><span></span><code>node<span class="w"> </span>prisma-server.js
<span class="c1"># Test on http://localhost:3001</span>
</code></pre>
</div>

<p><strong>3. Commit &amp; Push</strong>:</p>

<div class="codehilite">
<pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Fix: Description of change</span>

<span class="s2">- Detail 1</span>
<span class="s2">- Detail 2</span>

<span class="s2">ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)</span>

<span class="s2">Co-Authored-By: Claude &lt;noreply@anthropic.com&gt;&quot;</span>

git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</code></pre>
</div>

<p><strong>4. Railway Auto-Deploys</strong>:</p>

<ul>
<li>Detects push</li>
<li>Builds (~1 min)</li>
<li>Deploys (~30 sec)</li>
<li>Total: ~2 minutes</li>
</ul>

<p><strong>5. Verify</strong>:</p>

<div class="codehilite">
<pre><span></span><code>curl<span class="w"> </span>https://brrow-backend-nodejs-production.up.railway.app/health
<span class="c1"># Check version number</span>
</code></pre>
</div>

<h3 id="ios-update">iOS Update</h3>

<p><strong>1. Make Changes</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Edit Swift files in Xcode</span>
</code></pre>
</div>

<p><strong>2. Test</strong>:</p>

<pre><code>Run on simulator (âŒ˜R)
Run on physical device
Test all affected features
</code></pre>

<p><strong>3. Increment Build</strong>:</p>

<pre><code>Brrow target â†’ General â†’ Build: 594 â†’ 595
</code></pre>

<p><strong>4. Archive</strong>:</p>

<pre><code>Product â†’ Archive
Verify archive shows as "iOS App"
</code></pre>

<p><strong>5. Distribute</strong>:</p>

<pre><code>Organizer â†’ Distribute App â†’ App Store Connect
Wait for processing
</code></pre>

<p><strong>6. Submit</strong>:</p>

<pre><code>App Store Connect â†’ Select build â†’ Submit for Review
</code></pre>

<hr />

<h2 id="rollback-strategies">Rollback Strategies</h2>

<h3 id="backend-rollback-railway">Backend Rollback (Railway)</h3>

<p><strong>Option 1: Redeploy Previous Commit</strong>:</p>

<ol>
<li>Railway Dashboard</li>
<li>Deployments tab</li>
<li>Find working deployment</li>
<li>Click "â‹¯" â†’ "Redeploy"</li>
</ol>

<p><strong>Option 2: Git Revert</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Find bad commit</span>
git<span class="w"> </span>log<span class="w"> </span>--oneline<span class="w"> </span>-10

<span class="c1"># Revert it</span>
git<span class="w"> </span>revert<span class="w"> </span>&lt;commit-hash&gt;
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master

<span class="c1"># Railway auto-deploys reverted code</span>
</code></pre>
</div>

<p><strong>Option 3: Manual Rollback</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Reset to previous commit</span>
git<span class="w"> </span>reset<span class="w"> </span>--hard<span class="w"> </span>&lt;working-commit-hash&gt;
git<span class="w"> </span>push<span class="w"> </span>--force<span class="w"> </span>origin<span class="w"> </span>master

<span class="c1"># âš ï¸ Use with caution - rewrites history</span>
</code></pre>
</div>

<h3 id="ios-rollback">iOS Rollback</h3>

<p><strong>Can't rollback after approval</strong>, but can:</p>

<p><strong>Option 1: Remove from Sale</strong>:</p>

<ul>
<li>App Store Connect â†’ Brrow</li>
<li>Pricing and Availability</li>
<li>"Remove from Sale"</li>
</ul>

<p><strong>Option 2: Submit Hotfix</strong>:</p>

<ul>
<li>Fix critical bug</li>
<li>Increment build: 595 â†’ 596</li>
<li>Archive &amp; upload</li>
<li>Submit with "Expedited Review" request</li>
</ul>

<p><strong>Option 3: Revert Build</strong> (before release):</p>

<ul>
<li>App Store Connect â†’ TestFlight</li>
<li>Remove problematic build</li>
<li>Select previous working build</li>
<li>Submit for review</li>
</ul>

<hr />

<h2 id="security-updates">Security Updates</h2>

<h3 id="regular-maintenance">Regular Maintenance</h3>

<p><strong>Monthly Checklist</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Update Node.js dependencies (<code>npm update</code>)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Update CocoaPods (<code>pod update</code>)</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Review Railway logs for errors</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Check Stripe Dashboard for issues</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Monitor Firebase usage</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Review App Store ratings/reviews</li>
</ul>

<p><strong>Security Patches</strong>:</p>

<ul>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Update critical dependencies</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Test thoroughly</li>
<li><input type="checkbox" class="task-list-item-checkbox" disabled> Deploy immediately if security-related</li>
</ul>

<h3 id="dependency-updates">Dependency Updates</h3>

<p><strong>Backend</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Check for updates</span>
npm<span class="w"> </span>outdated

<span class="c1"># Update specific package</span>
npm<span class="w"> </span>update<span class="w"> </span>express

<span class="c1"># Update all (careful!)</span>
npm<span class="w"> </span>update

<span class="c1"># Audit for vulnerabilities</span>
npm<span class="w"> </span>audit
npm<span class="w"> </span>audit<span class="w"> </span>fix
</code></pre>
</div>

<p><strong>iOS</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Check for updates</span>
pod<span class="w"> </span>outdated

<span class="c1"># Update specific pod</span>
pod<span class="w"> </span>update<span class="w"> </span>StripePaymentSheet

<span class="c1"># Update all</span>
pod<span class="w"> </span>update
</code></pre>
</div>

<p><strong>âš ï¸ Always test after updates!</strong></p>

<hr />

<h1 id="quick-reference">ğŸ“Œ Quick Reference</h1>

<h2 id="essential-urls">Essential URLs</h2>

<table>
<thead>
<tr>
  <th>Service</th>
  <th>URL</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Production Backend</td>
  <td>https://brrow-backend-nodejs-production.up.railway.app</td>
</tr>
<tr>
  <td>Railway Dashboard</td>
  <td>https://railway.app</td>
</tr>
<tr>
  <td>Stripe Dashboard</td>
  <td>https://dashboard.stripe.com</td>
</tr>
<tr>
  <td>App Store Connect</td>
  <td>https://appstoreconnect.apple.com</td>
</tr>
<tr>
  <td>Firebase Console</td>
  <td>https://console.firebase.google.com</td>
</tr>
<tr>
  <td>Cloudinary Dashboard</td>
  <td>https://cloudinary.com/console</td>
</tr>
</tbody>
</table>

<h2 id="essential-commands">Essential Commands</h2>

<p><strong>Backend</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Start locally</span>
node<span class="w"> </span>prisma-server.js

<span class="c1"># Database migrations</span>
npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>dev
npx<span class="w"> </span>prisma<span class="w"> </span>generate
npx<span class="w"> </span>prisma<span class="w"> </span>db<span class="w"> </span>push

<span class="c1"># Deploy (auto via git push)</span>
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</code></pre>
</div>

<p><strong>iOS</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Install dependencies</span>
pod<span class="w"> </span>install

<span class="c1"># Clean build</span>
âŒ˜â‡§K<span class="w"> </span><span class="k">in</span><span class="w"> </span>Xcode

<span class="c1"># Archive</span>
Product<span class="w"> </span>â†’<span class="w"> </span>Archive

<span class="c1"># Run</span>
âŒ˜R
</code></pre>
</div>

<h2 id="essential-environment-variables">Essential Environment Variables</h2>

<p><strong>Switch to Test Mode</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span>sk_test_...
<span class="nv">STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span>pk_test_...
</code></pre>
</div>

<p><strong>Switch to Live Mode</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span>sk_live_...
<span class="nv">STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span>pk_live_...
</code></pre>
</div>

<h2 id="support-contacts">Support Contacts</h2>

<p><strong>Claude Code</strong>: This documentation
<strong>GitHub</strong>: https://github.com/shalinratna/brrow-backend-nodejs
<strong>Owner</strong>: Shalin Ratna (shalinratna@gmail.com)</p>

<hr />

<h1 id="document-update-log">ğŸ“ Document Update Log</h1>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Version</th>
  <th>Changes</th>
  <th>Updated By</th>
</tr>
</thead>
<tbody>
<tr>
  <td>2025-10-08</td>
  <td>1.0.0</td>
  <td>Initial comprehensive documentation created</td>
  <td>Claude Code</td>
</tr>
</tbody>
</table>

<hr />

<p><strong>ğŸ¯ This is a living document. All future updates will be added here instead of creating new .md files.</strong></p>

<p><strong>ğŸ“˜ Bookmark this file</strong>: <code>/Users/shalin/Documents/Projects/Xcode/Brrow/BRROW_COMPLETE_SYSTEM_DOCUMENTATION.md</code></p>

    </div>
</body>
</html>
